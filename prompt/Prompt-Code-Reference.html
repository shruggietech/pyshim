<!DOCTYPE html>
<html>
<head>
<title>Prompt-Code-Reference.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="prompt-code-reference">Prompt Code Reference</h1>
<h2 id="readmemd"><code>.\README.md</code></h2>
<p>A deterministic, context-aware <strong>Python shim</strong> for Windows that lets you control <em>which</em> Python interpreter is used by apps, projects, and background tools — without breaking the global environment.</p>
<hr>
<h3 id="overview">Overview</h3>
<p><strong>pyshim</strong> is a lightweight command router that sits in front of <code>python.exe</code>.<br>
It intercepts all calls to <code>python</code> and dynamically decides which interpreter to run based on context and configuration.</p>
<p>This is especially useful when:</p>
<ul>
<li>Multiple Python versions (e.g., 3.8, 3.11, 3.12) are installed.</li>
<li>You want per-project or per-app version pinning.</li>
<li>You need background tools and scripts to consistently use the same interpreter as your shell session.</li>
<li>You don’t want to fight Windows’ confusing PATH order or <code>py launcher</code> behavior.</li>
</ul>
<hr>
<h3 id="how-it-works">How It Works</h3>
<p>When you call <code>python</code>, pyshim resolves the appropriate interpreter using this priority chain:</p>
<ol>
<li>
<p><strong>One-shot flag</strong>
If called with <code>python --interpreter &quot;SPEC&quot; -- [args]</code>, that spec is used for this invocation only.</p>
</li>
<li>
<p><strong>Session override</strong>
If the environment variable <code>PYSHIM_INTERPRETER</code> is set (via <code>Use-Python</code> without <code>-Persist</code>), that spec is used.</p>
</li>
<li>
<p><strong>App-target override</strong>
If the environment variable <code>PYSHIM_TARGET</code> is set (e.g., <code>MyApp</code>), pyshim checks for
<code>C:\bin\shims\python@MyApp.env</code>.</p>
</li>
<li>
<p><strong>Project-level pin</strong>
If a <code>.python-version</code> file exists in the current directory or any parent, that spec is used.</p>
</li>
<li>
<p><strong>Global persistence file</strong>
If <code>C:\bin\shims\python.env</code> exists (and persistence isn't disabled), pyshim uses that.</p>
</li>
<li>
<p><strong>Fallback chain</strong>
If no specific interpreter is found, pyshim falls back to:</p>
<pre class="hljs"><code><div>py -3.12 → py -3 → conda run -n base python → real python.exe → (error if none found)
</div></code></pre>
<p><strong>Note</strong>: The system requires the Windows Python Launcher (<code>py.exe</code>) or Conda to be installed. The fallback intentionally uses <code>py.exe</code> and searches for real <code>python.exe</code> outside the shim directory to avoid infinite recursion (since <code>python.bat</code> IS the <code>python</code> command in your PATH).</p>
</li>
</ol>
<hr>
<h3 id="installation">Installation</h3>
<ol>
<li>
<p><strong>Install the Windows Python Launcher</strong> (if not already installed):</p>
<ul>
<li>Download and install any Python version from <a href="https://www.python.org/downloads/">python.org</a></li>
<li>Check <strong>&quot;Install launcher for all users (recommended)&quot;</strong> during installation</li>
<li>This installs <code>py.exe</code> to <code>C:\Windows\</code> (required for fallback chain)</li>
</ul>
</li>
<li>
<p>Create a directory for your shims (recommended: <code>C:\bin\shims</code>).</p>
</li>
<li>
<p>Copy these files from the repository:</p>
<ul>
<li><code>python.bat</code></li>
<li><code>pip.bat</code></li>
<li><code>pythonw.bat</code></li>
<li><code>pyshim.psm1</code></li>
</ul>
</li>
<li>
<p>Add <code>C:\bin\shims</code> to your <strong>PATH</strong> and move it to the top of the PATH order.</p>
</li>
<li>
<p>Import the PowerShell module from your profile:</p>
<pre class="hljs"><code><div><span class="hljs-built_in">Import-Module</span> <span class="hljs-string">'C:\bin\shims\pyshim.psm1'</span>
</div></code></pre>
</li>
<li>
<p>Restart PowerShell.</p>
</li>
</ol>
<hr>
<h3 id="usage">Usage</h3>
<h4 id="global-interpreter">Global Interpreter</h4>
<p>Set the global default interpreter for all sessions:</p>
<pre class="hljs"><code><div><span class="hljs-built_in">Use-Python</span> <span class="hljs-literal">-Spec</span> <span class="hljs-string">'py:3.12'</span> <span class="hljs-literal">-Persist</span>
</div></code></pre>
<p>This writes to <code>C:\bin\shims\python.env</code>:</p>
<pre class="hljs"><code><div>py:3.12
</div></code></pre>
<p>Now, any call to <code>python</code>—including from apps and services—will use that version.</p>
<hr>
<h4 id="session-only-interpreter">Session-Only Interpreter</h4>
<pre class="hljs"><code><div><span class="hljs-built_in">Use-Python</span> <span class="hljs-literal">-Spec</span> <span class="hljs-string">'conda:tools'</span>
</div></code></pre>
<p>This sets the interpreter for the <strong>current shell session</strong> only.
Background apps will still use the global default.</p>
<hr>
<h4 id="disable-global-persistence">Disable Global Persistence</h4>
<p>To temporarily ignore the persisted version:</p>
<pre class="hljs"><code><div><span class="hljs-built_in">Disable-PythonPersistence</span>
</div></code></pre>
<p>This creates <code>C:\bin\shims\python.nopersist</code>, which causes the shim to skip <code>python.env</code>.</p>
<p>To re-enable:</p>
<pre class="hljs"><code><div><span class="hljs-built_in">Enable-PythonPersistence</span>
</div></code></pre>
<hr>
<h4 id="per-app-overrides">Per-App Overrides</h4>
<p>You can pin specific apps to specific interpreters:</p>
<pre class="hljs"><code><div><span class="hljs-built_in">Set-AppPython</span> <span class="hljs-literal">-App</span> <span class="hljs-string">'MyService'</span> <span class="hljs-literal">-Spec</span> <span class="hljs-string">'conda:svc'</span>
</div></code></pre>
<p>This creates <code>C:\bin\shims\python@MyService.env</code> containing:</p>
<pre class="hljs"><code><div>conda:svc
</div></code></pre>
<p>When that app launches with <code>PYSHIM_TARGET=MyService</code>, it uses the pinned interpreter.</p>
<p>Example:</p>
<pre class="hljs"><code><div>@<span class="hljs-built_in">echo</span> off
<span class="hljs-built_in">set</span> PYSHIM_TARGET=MyService
python -V
</div></code></pre>
<hr>
<h4 id="per-project-versions">Per-Project Versions</h4>
<p>Drop a <code>.python-version</code> file in your project root:</p>
<pre class="hljs"><code><div>py:3.11
</div></code></pre>
<p>or</p>
<pre class="hljs"><code><div>conda:myenv
</div></code></pre>
<p>When you run <code>python</code> inside that folder, pyshim automatically respects the project’s version.</p>
<hr>
<h4 id="one-shot-command-execution">One-Shot Command Execution</h4>
<p>You can also run a single command with a specific interpreter, without persistence:</p>
<pre class="hljs"><code><div>Run<span class="hljs-literal">-WithPython</span> <span class="hljs-literal">-Spec</span> <span class="hljs-string">'py:3.11'</span> -- <span class="hljs-literal">-m</span> pip -<span class="hljs-literal">-version</span>
</div></code></pre>
<hr>
<h3 id="package-strategy">Package Strategy</h3>
<p>To keep your system clean and predictable:</p>
<ul>
<li><strong>Global CLI tools</strong> → Install with <code>pipx</code>.
Each tool gets its own isolated virtual environment.</li>
<li><strong>Per-project dependencies</strong> → Use a <code>.venv</code> created by the interpreter chosen by pyshim.</li>
<li><strong>Cache for speed</strong> → Set <code>PIP_CACHE_DIR=%LOCALAPPDATA%\pip\cache</code>.</li>
<li><strong>Conda users</strong> → Continue managing environments normally (<code>conda:envname</code> specs work seamlessly).</li>
</ul>
<p>This hybrid model ensures:</p>
<ul>
<li>Background apps remain stable.</li>
<li>Projects stay isolated.</li>
<li>Installations reuse cached wheels for efficiency.</li>
</ul>
<hr>
<h3 id="quick-test">Quick Test</h3>
<p>Once installed, open PowerShell and run:</p>
<pre class="hljs"><code><div><span class="hljs-built_in">Use-Python</span> <span class="hljs-literal">-Spec</span> <span class="hljs-string">'py:3.12'</span> <span class="hljs-literal">-Persist</span>
python <span class="hljs-literal">-V</span>
pip -<span class="hljs-literal">-version</span>
Run<span class="hljs-literal">-WithPython</span> <span class="hljs-literal">-Spec</span> <span class="hljs-string">'py:3.11'</span> -- <span class="hljs-literal">-c</span> <span class="hljs-string">"print('hello from 3.11')"</span>
</div></code></pre>
<hr>
<h3 id="example-directory-layout">Example Directory Layout</h3>
<pre class="hljs"><code><div>C:\
└── bin\
    └── shims\
        ├── python.bat
        ├── pip.bat
        ├── pythonw.bat
        ├── pyshim.psm1
        ├── python.env
        ├── python@MyService.env
        └── python.nopersist
</div></code></pre>
<hr>
<h3 id="naming-conventions">Naming Conventions</h3>
<ul>
<li><code>python.env</code> — global persistent interpreter spec.</li>
<li><code>.python-version</code> — project-local interpreter spec.</li>
<li><code>python@AppName.env</code> — per-application interpreter spec.</li>
<li><code>python.nopersist</code> — disables persistence globally.</li>
</ul>
<hr>
<h3 id="supported-spec-formats">Supported Spec Formats</h3>
<table>
<thead>
<tr>
<th>Format</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>py:3.12</code></td>
<td>Use Python 3.12 via Windows launcher.</td>
</tr>
<tr>
<td><code>conda:myenv</code></td>
<td>Use Conda environment <code>myenv</code>.</td>
</tr>
<tr>
<td><code>C:\Path\to\python.exe</code></td>
<td>Use this exact interpreter binary.</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="example-workflows">Example Workflows</h3>
<h4 id="developer-switching-between-projects">Developer Switching Between Projects</h4>
<pre class="hljs"><code><div>cd ~/dev/project<span class="hljs-literal">-a</span>
python <span class="hljs-literal">-V</span>  <span class="hljs-comment"># =&gt; Python 3.12 (from .python-version)</span>

cd ~/dev/project<span class="hljs-literal">-b</span>
python <span class="hljs-literal">-V</span>  <span class="hljs-comment"># =&gt; Python 3.10 (different .python-version)</span>
</div></code></pre>
<h4 id="background-service-isolation">Background Service Isolation</h4>
<pre class="hljs"><code><div><span class="hljs-built_in">Set-AppPython</span> <span class="hljs-literal">-App</span> <span class="hljs-string">'DataIndexer'</span> <span class="hljs-literal">-Spec</span> <span class="hljs-string">'conda:data'</span>
set PYSHIM_TARGET=DataIndexer
python <span class="hljs-literal">-m</span> indexer.main
</div></code></pre>
<h4 id="temporary-testing">Temporary Testing</h4>
<pre class="hljs"><code><div>Run<span class="hljs-literal">-WithPython</span> <span class="hljs-literal">-Spec</span> <span class="hljs-string">'py:3.9'</span> -- <span class="hljs-literal">-c</span> <span class="hljs-string">"import sys; print(sys.version)"</span>
</div></code></pre>
<hr>
<h3 id="license">License</h3>
<p>MIT License
Copyright (c) 2025 ShruggieTech</p>
<p>Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the &quot;Software&quot;), to deal
in the Software without restriction...</p>
<p><em>(full license text included in <a href="LICENSE">LICENSE</a>)</em></p>
<hr>
<h3 id="links">Links</h3>
<ul>
<li><a href="https://shruggie.tech/">ShruggieTech</a></li>
<li><a href="https://github.com/shruggietech/pyshim/releases">Latest Releases</a></li>
<li><a href="https://github.com/shruggietech/dev-handbook">dev-handbook Integration Docs</a></li>
</ul>
<hr>
<h3 id="credits">Credits</h3>
<p>Designed and maintained by h8rt3rmin8r for <strong>ShruggieTech LLC</strong>.
Originally conceived as part of the internal “dev-handbook” initiative for consistent Python environments across projects.</p>
<pre class="hljs"><code><div>¯\_(ツ)_/¯
</div></code></pre>
<h2 id="gitignore"><code>.\.gitignore</code></h2>
<pre class="hljs"><code><div># See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.js
.vscode
# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*
</div></code></pre>
<h2 id="examplespython-version"><code>.\examples\.python-version</code></h2>
<pre class="hljs"><code><div>C:\Users\you\miniconda3\envs\myproj\python.exe
</div></code></pre>
<h2 id="githubcopilot-instructionsmd"><code>.\.github\copilot-instructions.md</code></h2>
<p>This document provides instructions for AI coding agents to effectively assist in developing the pyshim project.</p>
<h3 id="project-overview-pyshim">Project Overview: pyshim</h3>
<p><strong>pyshim</strong> is a deterministic, context-aware Python shim system for Windows that intercepts <code>python</code>, <code>pip</code>, and <code>pythonw</code> calls to route them to the correct interpreter based on context. The system consists of three core components:</p>
<ol>
<li><strong>Batch Shims</strong> (<code>python.bat</code>, <code>pip.bat</code>, <code>pythonw.bat</code>) — Entry points that resolve interpreter specs through a priority chain and delegate to the actual interpreter</li>
<li><strong>PowerShell Module</strong> (<code>pyshim.psm1</code>) — User-facing cmdlets for managing interpreter selection and persistence</li>
<li><strong>Config Files</strong> (<code>python.env</code>, <code>python@AppName.env</code>, <code>.python-version</code>) — Text files storing interpreter specifications</li>
</ol>
<h4 id="architecture--resolution-priority">Architecture &amp; Resolution Priority</h4>
<p>When <code>python.bat</code> is invoked, it resolves the interpreter using this exact priority chain:</p>
<ol>
<li><strong>One-shot flag</strong>: <code>--interpreter &quot;SPEC&quot; --</code> (used by <code>Run-WithPython</code> and direct invocation)</li>
<li><strong>Session variable</strong>: <code>$env:PYSHIM_INTERPRETER</code> (set by <code>Use-Python</code> without <code>-Persist</code>)</li>
<li><strong>App-target override</strong>: <code>python@%PYSHIM_TARGET%.env</code> (set by <code>Set-AppPython</code>)</li>
<li><strong>Project pin</strong>: <code>.python-version</code> file in current directory or parent chain (walks up directory tree)</li>
<li><strong>Global persistence</strong>: <code>python.env</code> (unless <code>python.nopersist</code> marker exists)</li>
<li><strong>Fallback chain</strong>: <code>py -3.12</code> → <code>py -3</code> → <code>conda run -n base python</code> → real <code>python.exe</code> (not in shim dir) → (error if none found)</li>
</ol>
<p><strong>Important</strong>: The fallback chain avoids infinite recursion by:</p>
<ul>
<li>Using <code>PYSHIM_FROM_PY</code> guard variable when called from <code>py.bat</code></li>
<li>Skipping <code>python.exe</code> results that point to the shim directory itself</li>
<li>Using explicit commands (<code>py.exe</code>, <code>conda</code>, absolute paths) rather than bare <code>python</code></li>
</ul>
<h4 id="interpreter-spec-formats">Interpreter Spec Formats</h4>
<p>The system supports three spec formats (stored in <code>.env</code> and <code>.python-version</code> files):</p>
<ul>
<li><code>py:3.12</code> — Uses Windows <code>py</code> launcher with specific version</li>
<li><code>conda:envname</code> — Uses Conda environment</li>
<li><code>C:\Path\to\python.exe</code> — Absolute path to interpreter binary</li>
</ul>
<p>These specs are parsed by the <code>:RESOLVE_SPEC</code> subroutine in <code>python.bat</code> (lines 91-115).</p>
<h4 id="key-files--their-roles">Key Files &amp; Their Roles</h4>
<ul>
<li><strong><code>python.bat</code></strong> (~137 lines): Core resolver logic with batch subroutines <code>:RESOLVE_SPEC</code> and <code>:FIND_DOTFILE</code> (walks directory tree for <code>.python-version</code>)</li>
<li><strong><code>pip.bat</code></strong> (4 lines): Trivial wrapper that calls <code>python.bat -m pip</code></li>
<li><strong><code>pythonw.bat</code></strong> (4 lines): Best-effort headless wrapper (delegates to <code>python.bat</code>)</li>
<li><strong><code>pyshim.psm1</code></strong> (124 lines): PowerShell module with cmdlets <code>Use-Python</code>, <code>Disable-PythonPersistence</code>, <code>Enable-PythonPersistence</code>, <code>Set-AppPython</code>, <code>Run-WithPython</code></li>
<li><strong><code>tests/smoke.ps1</code></strong>: Basic smoke test verifying <code>python -V</code>, <code>pip --version</code>, and <code>Run-WithPython</code></li>
</ul>
<p><strong>Note</strong>: <code>py.bat</code> is NOT included — the shim relies on the native Windows Python Launcher (<code>py.exe</code>) being installed globally.</p>
<h4 id="critical-implementation-details">Critical Implementation Details</h4>
<p><strong>Batch File Constraints</strong>:</p>
<ul>
<li>Uses <code>ENABLEDELAYEDEXPANSION</code> for variable expansion in loops</li>
<li>Subroutines use <code>call :LABEL</code> pattern with output variables passed by name (e.g., <code>call :RESOLVE_SPEC &quot;%SPEC%&quot; RESOLVED_CMD</code>)</li>
<li><code>:FIND_DOTFILE</code> implements parent directory walking using <code>%%~dpD</code> to extract parent paths</li>
<li>Exit codes must be preserved with <code>exit /b %ERRORLEVEL%</code></li>
<li><strong>Critical</strong>: Final fallback uses <code>py</code> (not <code>python</code>) to prevent infinite recursion since <code>python.bat</code> IS the <code>python</code> command in PATH</li>
</ul>
<p><strong>PowerShell Module Design</strong>:</p>
<ul>
<li>All cmdlets use <code>[CmdletBinding()]</code> with no parameters (lightweight functions)</li>
<li>File operations use <code>-LiteralPath</code> for whitespace-safe handling</li>
<li>Files written with <code>-NoNewline -Encoding ASCII</code> to avoid trailing newlines and BOM issues</li>
<li>Hardcoded shim directory: <code>C:\bin\shims</code> (not parameterized — design choice for simplicity)</li>
</ul>
<p><strong>File Format Discipline</strong>:</p>
<ul>
<li>All <code>.env</code> files contain a single line with no trailing newline (enforced by <code>Set-Content -NoNewline</code>)</li>
<li>Parsed with <code>for /f &quot;usebackq delims=&quot;</code> in batch to preserve exact content</li>
<li><code>.python-version</code> files follow same single-line format</li>
</ul>
<h4 id="development-workflows">Development Workflows</h4>
<p><strong>Testing Changes</strong>:</p>
<pre class="hljs"><code><div><span class="hljs-comment">## Run smoke test to verify basic functionality</span>
.\tests\smoke.ps1

<span class="hljs-comment">## Manual verification of resolution priority</span>
<span class="hljs-built_in">Use-Python</span> <span class="hljs-literal">-Spec</span> <span class="hljs-string">'py:3.12'</span> <span class="hljs-literal">-Persist</span>
python <span class="hljs-literal">-V</span>
</div></code></pre>
<p><strong>Adding New Cmdlets</strong>:</p>
<ul>
<li>Follow existing pattern in <code>pyshim.psm1</code></li>
<li>Include full comment-based help with <code>.SYNOPSIS</code>, <code>.DESCRIPTION</code>, <code>.PARAMETER</code>, <code>.EXAMPLE</code></li>
<li>Use <code>$ShimDir = 'C:\bin\shims'</code> for path construction</li>
<li>File writes should use <code>-NoNewline -Encoding ASCII</code></li>
</ul>
<p><strong>Modifying Resolution Logic</strong>:</p>
<ul>
<li>Changes to priority chain happen in <code>python.bat</code> (lines 10-88)</li>
<li>Spec parsing logic lives in <code>:RESOLVE_SPEC</code> subroutine (lines 91-115)</li>
<li>Always preserve <code>%ERRORLEVEL%</code> when delegating to resolved interpreter</li>
</ul>
<h4 id="common-pitfalls">Common Pitfalls</h4>
<ul>
<li><strong>Trailing Newlines</strong>: Config files MUST NOT have trailing newlines (breaks batch parsing)</li>
<li><strong>Path Separators</strong>: Use <code>Join-Path</code> in PowerShell; avoid hardcoded <code>\</code> for potential Linux compatibility</li>
<li><strong>Delayed Expansion</strong>: Required in batch for variable mutation in loops/conditionals</li>
<li><strong>Case Sensitivity</strong>: Batch is case-insensitive, but <code>.python-version</code> filename is lowercase by convention (matching <code>pyenv</code>)</li>
<li><strong>Infinite Recursion</strong>: Never use bare <code>python</code> in fallback chain — <code>python.bat</code> IS the <code>python</code> command, so it would call itself. Always use <code>py.exe</code> or absolute paths in fallbacks</li>
</ul>
<h4 id="design-philosophy">Design Philosophy</h4>
<p>pyshim prioritizes <strong>determinism</strong> and <strong>zero-configuration</strong> over flexibility:</p>
<ul>
<li>No installer required — just copy files and update PATH</li>
<li>Hardcoded paths (<code>C:\bin\shims</code>) for predictability</li>
<li>Minimal dependencies (PowerShell 5.1+, Windows batch)</li>
<li>Spec files use simple text format (no JSON/YAML parsing overhead)</li>
<li>Global state is explicit (<code>.env</code> files in shim directory, not registry or AppData)</li>
</ul>
<h3 id="standards-for-writing-style-and-tone">Standards for Writing Style and Tone</h3>
<ul>
<li>Always write in a way that reads as genuinely human and free from any linguistic patterns that commonly expose AI-generated text. Avoid all &quot;AI tells,&quot; including but not limited to: excessive politeness, generic transitions (e.g., &quot;Furthermore,&quot; &quot;In conclusion,&quot; &quot;Overall&quot;), filler phrases (&quot;It's important to note that&quot;), parallel-sounding constructions (&quot;not only...but also&quot;), and overly balanced or neatly summarized conclusions.</li>
<li>Favor a natural flow that mirrors how an experienced writer or professional would actually communicate:
<ul>
<li>Use sentence length variation (occasional fragments are fine).</li>
<li>Use contractions naturally (&quot;I'm,&quot; &quot;don't,&quot; &quot;that's&quot;).</li>
<li>Avoid corporate buzzwords and inflated adjectives unless context demands them.</li>
<li>Use clarity, subtle rhythm, and precision over &quot;niceness.&quot;</li>
<li>Never overexplain or restate points unless it aids comprehension.</li>
<li>Eliminate template phrasing like &quot;Here's a breakdown,&quot; &quot;Let's explore,&quot; or &quot;This means that.&quot;</li>
</ul>
</li>
<li>The tone should sound authentic, thoughtful, and intentional, not algorithmically tidy. Write as if the content were edited by a sharp human who values brevity, rhythm, and nuance more than structure or formality.</li>
<li>Use a little bit of sarcasm or dry humor where appropriate and have fun talking trash about tools and frameworks developed by Microsoft (they deserve it).</li>
</ul>
<h3 id="system-environment-handling">System Environment Handling</h3>
<h4 id="sensitivity-to-file-and-directory-names">Sensitivity to File and Directory Names</h4>
<p>While this project is likely to be developed in a Windows 11 environment, it should be assumed that some (or all) of the code may be run in an Ubuntu Linux production environment. Windows file paths are case-insensitive, while Linux file paths use a much more robust case-sensitive approach. As such, when writing scripts that interact with the filesystem, care must be taken to ensure that file and directory names are treated in a universally compatible manner at all times. In addition to the matter of case sensitivity, Windows file systems use (for some unknowable reason) a <code>\</code> (backslash &quot;escape&quot;) separator character, while Linux file systems use a <code>/</code> (forward slash) separator. So while it would be convenient to treat all paths like Internet URLs like Linux, when writing scripts that interact with the filesystem, care must be taken to ensure that file and directory paths are constructed and parsed correctly for the target operating system (thanks to Microsoft).</p>
<p>In Powershell, use a standard discovery method to determine the appropriate path separator for the current operating system and store that separator in a variable: <code>$Sep</code> (adapt this method for other scripting languages as needed):</p>
<pre class="hljs"><code><div><span class="hljs-variable">$Sep</span> = [<span class="hljs-type">IO.Path</span>]::DirectorySeparatorChar
</div></code></pre>
<p>File and directory names should avoid spaces where possible. However, scripts must always account for cases where whitespace exists. When handling paths or user inputs in PowerShell, use the <code>-LiteralPath</code> parameter where supported (instead of the intuitive but ill-advised <code>-Path</code> parameter). Always verify the compatibility of the <code>-LiteralPath</code> parameter with each cmdlet to prevent errors when processing path references, as some cmdlets do NOT support <code>-LiteralPath</code>.</p>
<p>On a side note, one of the original creators of PowerShell publicly complained about the broken state of the <code>-Path</code> parameter and its inconsistent handling of special characters. So (as is the case with all dumpster fire code written by Microsoft) this is a known fundamental bad-practice end-user pain point that Microsoft just simply ignores (okay I'm good now - moving on).</p>
<h4 id="python-versioning-and-management">Python Versioning and Management</h4>
<ul>
<li>
<p>The system-wide Python installation is exactly version <code>3.12.10</code>. This should be taken into account when writing or updating scripts that may interact with the Python installation or its packages.</p>
</li>
<li>
<p>Whenever possible, try to use virtual environments for Python projects to avoid dependency conflicts and ensure consistent behavior across different development and production environments.</p>
</li>
<li>
<p>Consider using python-poetry.org for managing Python project dependencies and virtual environments.</p>
</li>
<li>
<p>If Poetry is not installed, it can be installed using one of the following commands:</p>
<p>Install Poetry on Windows 11 (Powershell):</p>
<pre class="hljs"><code><div>(<span class="hljs-built_in">Invoke-WebRequest</span> <span class="hljs-literal">-Uri</span> https://install.python<span class="hljs-literal">-poetry</span>.org <span class="hljs-literal">-UseBasicParsing</span>).Content | py -
</div></code></pre>
<p>Install Poetry on Ubuntu Linux (Bash):</p>
<pre class="hljs"><code><div>curl -sSL https://install.python-poetry.org | python3 -
</div></code></pre>
<p>Note: You may need to also set up your system PATH to include Poetry's bin directory. Refer to the official Poetry documentation for guidance.</p>
</li>
<li>
<p>Python is another dumpster fire situation. Backwards compatibility is a nightmare, and the ecosystem is riddled with poorly maintained packages and security vulnerabilities, and almost every project prides itself on reinventing the wheel. Always expect the worst and check the maintenance status of any third-party libraries before including them in a project, and only include well-established, actively maintained packages AT ALL TIMES.</p>
</li>
</ul>
<h3 id="general-code-formatting">General Code Formatting</h3>
<ul>
<li>
<p><strong>Nested Helper Functions:</strong> For complex functions, break down logic into smaller, single-purpose nested helper functions. These helpers should follow a <code>ParentFunctionName-HelperAction</code> naming convention (e.g., <code>ApkExtract-ResolvePath</code>).</p>
</li>
<li>
<p><strong>Variable Naming Convention:</strong> All variables should use <strong>PascalCase</strong> (e.g., <code>$NumbersCount</code>, <code>$InputFile</code>, <code>$ExitCode</code>). Do not use snake_case or camelCase unless absolutely necessary (like conformance with existing third-party code).</p>
</li>
<li>
<p><strong>Clean Whitespace:</strong></p>
<ul>
<li>Never include a line that contains only whitespace characters. If a blank line is needed for readability, it must be completely empty.</li>
<li>Never leave trailing whitespace at the end of any line.</li>
<li>Always leave a single blank line between major logical sections of code (e.g., between function declarations)</li>
<li>Never indent code using tab characters. Always use exactly <strong>four spaces</strong> for each level of indentation.</li>
</ul>
</li>
<li>
<p><strong>Brace Style (One True Brace Style):</strong> When declaring functions, <code>if</code> statements, loops, or any other code block, the opening curly brace <code>{</code> <strong>must</strong> be on the same line as the declaration. The closing curly brace <code>}</code> <strong>must</strong> be on its own line, aligned with the start of the declaration.</p>
<pre class="hljs"><code><div><span class="hljs-comment"># Correct</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Get-Something</span></span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$Condition</span>) {
        <span class="hljs-comment"># Do work</span>
    }
}

<span class="hljs-comment"># Incorrect</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Get-Something</span></span>
{
    <span class="hljs-comment"># ...</span>
}
</div></code></pre>
</li>
</ul>
<h3 id="scripting-standards-powershell-focused">Scripting Standards (Powershell Focused)</h3>
<p>All non-Powershell scripts should include an appropriate shebang line at the top of the file:</p>
<ul>
<li>Bash: <code>#!/usr/bin/env bash</code></li>
<li>Python: <code>#!/usr/bin/env python3</code></li>
<li>Node.js: <code>#!/usr/bin/env node</code></li>
<li>etc.</li>
</ul>
<p>Important Note: Never include a shebang line in Powershell scripts. Doing so will prevent the script from behaving correctly in Windows environments.</p>
<p>All scripts and functions should closely adhere to the following general structure:</p>
<ol>
<li>Introduction
<ul>
<li><strong>Comprehensive ReadMe:</strong> Comprehensive comment-based Help Text documentation</li>
<li><strong><code>[CmdletBinding()]</code> Declaration:</strong> (Powershell only)</li>
<li><strong><code>Param()</code> Block:</strong> Define all input parameters (Powershell only)</li>
</ul>
</li>
<li>Declarations
<ul>
<li><strong>Function Declarations:</strong> Function and sub-function declarations in alphabetical order</li>
<li><strong>Variable &amp; Array Declarations:</strong> Variable and array declarations, including self-awareness variables (be sure to carefully sequence these correctly to avoid dependency issues when initializing variables that depend on other locally declared variables)</li>
</ul>
</li>
<li>Core Logic
<ul>
<li><strong>Catch Help Text Requests:</strong> Display the help text and gracefully exit if the <code>-Help</code> parameter is specified</li>
<li><strong>Validate Inputs:</strong> Validate user inputs or required environment variables if necessary</li>
<li><strong>Main Process Logic:</strong> The core logic of the script or function, broken down into logical sections with clear comments explaining each part</li>
</ul>
</li>
<li>Conclusion
<ul>
<li><strong>Return Output:</strong> Return outputs to the stdout stream and/or write require output files as needed</li>
<li><strong>Garbage Collection:</strong> Clean up any temporary files or resources used during execution</li>
<li><strong>Exit Gracefully:</strong> Exit with an appropriate exit code indicating success or failure (depending on the language, this may be implicit)</li>
</ul>
</li>
</ol>
<h4 id="comprehensive-readme">Comprehensive ReadMe</h4>
<p>Example comment-based help block for Powershell:</p>
<pre class="hljs"><code><div>&lt;#
.SYNOPSIS
    A brief summary of the function's purpose.
.DESCRIPTION
    A more detailed description of what the function does, how it behaves, and the kinds of inputs and outputs it handles.
.PARAMETER ParameterName
    A clear explanation of what this parameter is for along with any constraints or special behaviors.
.EXAMPLE
    A practical example of how to use the function.
.LINK
    [example.com](https://example.com/)
#&gt;
</div></code></pre>
<ul>
<li>When writing any Powershell script (or function or sub-function), always include a full comment-based help block at the very beginning of the file and before the internal logic of each function.</li>
<li>At a minimum, in Powershell, this block must include <code>.SYNOPSIS</code>, <code>.DESCRIPTION</code>, <code>.PARAMETER</code> for each parameter, and at least one <code>.EXAMPLE</code>. Include a <code>.LINK</code> for external references where applicable.</li>
<li>Relevant help text should be included in non-Powershell scripts as well (using appropriate interactive features and appropriate comment syntax).</li>
</ul>
<h4 id="cmdletbinding-powershell">CmdletBinding (Powershell)</h4>
<p>Example <code>[CmdletBinding()]</code> declaration:</p>
<pre class="hljs"><code><div>[<span class="hljs-type">CmdletBinding</span>(<span class="hljs-type">SupportsShouldProcess</span>=<span class="hljs-variable">$true</span>,<span class="hljs-type">ConfirmImpact</span>=<span class="hljs-string">'None'</span>,<span class="hljs-type">DefaultParameterSetName</span>=<span class="hljs-string">'Default'</span>)]
</div></code></pre>
<p>When writing PowerShell functions and scripts, always include a proper <code>[CmdletBinding()]</code> declaration directly following the comment-based help text. This ensures that the function behaves like a standard cmdlet, supporting common features like <code>-Verbose</code>, <code>-Debug</code>, and <code>-ErrorAction</code>.</p>
<ul>
<li>Avoid using empty whitespace inside the parentheses of <code>CmdletBinding()</code>. This line is already quite long, so keep it tight.</li>
<li>If the function performs actions that change system state (e.g., file operations), consider including <code>SupportsShouldProcess=$true</code> in the declaration.</li>
<li>Include <code>ConfirmImpact='None'</code> unless the function performs high-impact actions (who knows whatever that means).</li>
<li>Always specify a <code>DefaultParameterSetName='Default'</code> to ensure predictable behavior regardless of how many parameter sets are defined.</li>
<li>Additional attributes can be included if doing so would facilitate the function's specific needs and assumed use-cases (such as handling of pipeline inputs, etc). Make sure to understand the implications of each attribute before including it as these can completely break an entire script or function if misused.</li>
</ul>
<h4 id="param-block-powershell">Param Block (Powershell)</h4>
<p>Define all parameters within a <code>Param()</code> block immediately following the <code>[CmdletBinding()]</code> declaration. This ensures standard cmdlet behavior. Be sure to leave a blank line between each clump of attributes related to a single parameter for readability.</p>
<p>Example <code>Param()</code> block:</p>
<pre class="hljs"><code><div><span class="hljs-keyword">Param</span>(
    [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$true</span>,<span class="hljs-type">ParameterSetName</span>=<span class="hljs-string">'Default'</span>)]
    [<span class="hljs-type">Alias</span>(<span class="hljs-string">"f"</span>)]
    [<span class="hljs-type">System.String</span>]<span class="hljs-variable">$File</span>,

    [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$false</span>,<span class="hljs-type">ParameterSetName</span>=<span class="hljs-string">'Default'</span>)]
    [<span class="hljs-type">Alias</span>(<span class="hljs-string">"o"</span>,<span class="hljs-string">"outfile"</span>)]
    [<span class="hljs-type">System.String</span>]<span class="hljs-variable">$Output</span> = <span class="hljs-string">"ProjectOutput.txt"</span>,

    [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$true</span>,<span class="hljs-type">ParameterSetName</span>=<span class="hljs-string">'HelpText'</span>)]
    [<span class="hljs-type">Alias</span>(<span class="hljs-string">"h"</span>)]
    [<span class="hljs-type">Switch</span>]<span class="hljs-variable">$Help</span>
)
</div></code></pre>
<ul>
<li><strong>Named Parameter Groups:</strong> Organize parameters into logical groups using the <code>ParameterSetName</code> attribute. This helps clarify which parameters can be used together and improves usability and discoverability from within the standard Help Text generator.</li>
<li><strong>Parameter Attributes:</strong> Use attributes like <code>[Parameter(Mandatory=$true)]</code> to enforce required parameters within the context of named parameter groups. The Help text parameter (<code>-Help</code>) should always inhabit a <code>HelpText</code> parameter group and be mandatory within that group.</li>
<li><strong>Parameter Aliases:</strong> Provide common, best-practice aliases for parameters to improve usability (e.g., <code>[Alias(&quot;f&quot;,&quot;file&quot;,&quot;inputfile&quot;)]</code>) but carefully avoid overly generic aliases that could conflict with other parameters. Conflicts in parameter names and aliases should be strongly avoided. Always remember that parameters are case-insensitive in PowerShell
<ul>
<li>Example: Including both <code>-File</code> and <code>-file</code> aliases would break the script or function.</li>
</ul>
</li>
<li><strong>Type Constraints:</strong> Strongly type all parameters (e.g., <code>[System.String]</code>, <code>[System.Boolean]</code>, <code>[Switch]</code>).</li>
<li><strong>Default Values:</strong> If an input has a highly-likely default value, assign default values to optional parameters directly in the <code>Param()</code> block (e.g., <code>$Verbosity = $true</code>) and avoid assigning defaults to mandatory parameters (as this angers the syntax parsers in Visual Studio).</li>
</ul>
<h4 id="self-awareness-variables">Self-Awareness Variables</h4>
<p>For effective logging and verbosity, functions and scripts should all declare &quot;self-awareness&quot; variables at the beginning to establish a caller reference string. This is especially important for nested functions to create a logical call stack.</p>
<p>Example self-awareness variable declarations:</p>
<pre class="hljs"><code><div><span class="hljs-comment">## Internal self-awareness variables for use in verbosity and logging</span>
<span class="hljs-keyword">$this</span>FunctionReference = <span class="hljs-string">"{0}"</span> <span class="hljs-operator">-f</span> <span class="hljs-variable">$MyInvocation</span>.MyCommand
<span class="hljs-keyword">$this</span>Sub<span class="hljs-function"><span class="hljs-keyword">Function</span> = "</span>{<span class="hljs-number">0</span>}<span class="hljs-string">" -f <span class="hljs-variable">$MyInvocation</span>.MyCommand
<span class="hljs-keyword">$this</span>Function = if (<span class="hljs-variable">$null</span> -eq <span class="hljs-keyword">$this</span>Function) { <span class="hljs-keyword">$this</span>SubFunction } else { -join("</span><span class="hljs-keyword">$this</span>Function<span class="hljs-string">", "</span>:<span class="hljs-string">", "</span><span class="hljs-keyword">$this</span>SubFunction<span class="hljs-string">") }
</span></div></code></pre>
<h2 id="promptmake-promptcodereferenceps1"><code>.\prompt\Make-PromptCodeReference.ps1</code></h2>
<pre class="hljs"><code><div><span class="hljs-comment">&lt;#
<span class="hljs-doctag">.SYNOPSIS</span>
    Generates a Markdown code reference file from project root files (intended for use in AI prompting).
<span class="hljs-doctag">.DESCRIPTION</span>
    Creates a comprehensive Markdown document containing all files from the project root directory
    with appropriate syntax highlighting. Excludes specific files like LICENSE and workspace files.
    README.md is processed first with headers downgraded one level. Each file is formatted as a
    level-two header followed by a code block with proper language syntax highlighting.
<span class="hljs-doctag">.PARAMETER Directory</span>
    The directory to scan for files. Defaults to the project root (..\). Use this to point the
    script at a different directory for processing.
    Alias: d
<span class="hljs-doctag">.PARAMETER Recurse</span>
    When specified, recursively scans subdirectories within the target directory. By default,
    only files in the root of the target directory are processed (non-recursive).
    Alias: r, recursive
<span class="hljs-doctag">.PARAMETER Force</span>
    When specified, includes hidden files in the output. By default, hidden files are excluded.
    Alias: f
<span class="hljs-doctag">.PARAMETER IncludeMarkdown</span>
    When specified, includes the full content of all Markdown files (other than README.md).
    By default, non-README Markdown files are listed with a placeholder message instead of
    their full content.
    Alias: i, includemd
<span class="hljs-doctag">.PARAMETER Help</span>
    Displays detailed help information for this script.
    Alias: h
<span class="hljs-doctag">.EXAMPLE</span>
    .\Make-PromptCodeReference.ps1

    Generates a code reference from files in the project root directory (non-recursive).
<span class="hljs-doctag">.EXAMPLE</span>
    .\Make-PromptCodeReference.ps1 -Directory 'C:\MyProject'

    Generates a code reference from files in C:\MyProject (non-recursive).
<span class="hljs-doctag">.EXAMPLE</span>
    .\Make-PromptCodeReference.ps1 -Recurse

    Generates a code reference from all files in the project root and subdirectories (recursive).
<span class="hljs-doctag">.EXAMPLE</span>
    .\Make-PromptCodeReference.ps1 -d 'C:\MyProject' -r

    Generates a code reference from all files in C:\MyProject and subdirectories using parameter aliases.
<span class="hljs-doctag">.EXAMPLE</span>
    .\Make-PromptCodeReference.ps1 -Force

    Generates a code reference from the project root including hidden files.
<span class="hljs-doctag">.EXAMPLE</span>
    .\Make-PromptCodeReference.ps1 -IncludeMarkdown

    Generates a code reference including the full content of all Markdown files (other than README.md).
<span class="hljs-doctag">.LINK</span>
    https://github.com/shruggietech/pyshim
#&gt;</span>

<span class="hljs-function">[<span class="hljs-type">CmdletBinding</span>(<span class="hljs-type">SupportsShouldProcess</span>=<span class="hljs-variable">$false</span>,<span class="hljs-type">ConfirmImpact</span>=<span class="hljs-string">'None'</span>,<span class="hljs-type">DefaultParameterSetName</span>=<span class="hljs-string">'Default'</span>)]</span>
<span class="hljs-keyword">Param</span>(
    [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$false</span>,<span class="hljs-type">ParameterSetName</span>=<span class="hljs-string">'Default'</span>)]
    [<span class="hljs-type">Alias</span>(<span class="hljs-string">"d"</span>)]
    [<span class="hljs-type">System.String</span>]<span class="hljs-variable">$Directory</span>,

    [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$false</span>,<span class="hljs-type">ParameterSetName</span>=<span class="hljs-string">'Default'</span>)]
    [<span class="hljs-type">Alias</span>(<span class="hljs-string">"r"</span>,<span class="hljs-string">"recursive"</span>)]
    [<span class="hljs-type">Switch</span>]<span class="hljs-variable">$Recurse</span>,

    [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$false</span>,<span class="hljs-type">ParameterSetName</span>=<span class="hljs-string">'Default'</span>)]
    [<span class="hljs-type">Alias</span>(<span class="hljs-string">"f"</span>)]
    [<span class="hljs-type">Switch</span>]<span class="hljs-variable">$Force</span>,

    [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$false</span>,<span class="hljs-type">ParameterSetName</span>=<span class="hljs-string">'Default'</span>)]
    [<span class="hljs-type">Alias</span>(<span class="hljs-string">"i"</span>,<span class="hljs-string">"includemd"</span>)]
    [<span class="hljs-type">Switch</span>]<span class="hljs-variable">$IncludeMarkdown</span>,

    [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$true</span>,<span class="hljs-type">ParameterSetName</span>=<span class="hljs-string">'HelpText'</span>)]
    [<span class="hljs-type">Alias</span>(<span class="hljs-string">"h"</span>)]
    [<span class="hljs-type">Switch</span>]<span class="hljs-variable">$Help</span>
)

<span class="hljs-comment"># Internal self-awareness variables for use in verbosity and logging</span>
<span class="hljs-keyword">$This</span>ScriptPath = <span class="hljs-variable">$MyInvocation</span>.MyCommand.Path
<span class="hljs-keyword">$This</span>FunctionReference = <span class="hljs-string">"{0}"</span> <span class="hljs-operator">-f</span> <span class="hljs-variable">$MyInvocation</span>.MyCommand
<span class="hljs-keyword">$This</span>Sub<span class="hljs-function"><span class="hljs-keyword">Function</span> = "</span>{<span class="hljs-number">0</span>}<span class="hljs-string">" -f <span class="hljs-variable">$MyInvocation</span>.MyCommand
<span class="hljs-keyword">$This</span>Function = if (<span class="hljs-variable">$null</span> -eq <span class="hljs-keyword">$This</span>Function) { <span class="hljs-keyword">$This</span>SubFunction } else { -join("</span><span class="hljs-keyword">$This</span>Function<span class="hljs-string">", "</span>:<span class="hljs-string">", "</span><span class="hljs-keyword">$This</span>SubFunction<span class="hljs-string">") }

# Catch help text requests
if ((<span class="hljs-variable">$Help</span>) -or (<span class="hljs-variable">$PSCmdlet</span>.ParameterSetName -eq 'HelpText')) {
    Get-Help "</span><span class="hljs-keyword">$This</span>ScriptPath<span class="hljs-string">" -Detailed
    exit
}

#-------------------------------------------------------------------------------
# Configuration
#-------------------------------------------------------------------------------

<span class="hljs-variable">$ProjectRoot</span> = if (<span class="hljs-variable">$Directory</span>) { <span class="hljs-variable">$Directory</span> } else { Join-Path <span class="hljs-variable">$PSScriptRoot</span> '..' }
<span class="hljs-variable">$OutputFile</span> = Join-Path <span class="hljs-variable">$PSScriptRoot</span> 'Prompt-Code-Reference.md'
<span class="hljs-variable">$ExcludedFiles</span> = @('LICENSE')

# Map file extensions to GitHub Markdown syntax highlighting tags
<span class="hljs-variable">$SyntaxMap</span> = @{
    '.bash'             = 'bash'
    '.bat'              = 'batch'
    '.c'                = 'c'
    '.cc'               = 'cpp'
    '.cfg'              = 'ini'
    '.clj'              = 'clojure'
    '.cmd'              = 'batch'
    '.code-workspace'   = 'json'
    '.conf'             = 'conf'
    '.cpp'              = 'cpp'
    '.cs'               = 'csharp'
    '.css'              = 'css'
    '.cxx'              = 'cpp'
    '.dockerfile'       = 'dockerfile'
    '.env'              = 'bash'
    '.gitignore'        = 'gitignore'
    '.go'               = 'go'
    '.h'                = 'c'
    '.hpp'              = 'cpp'
    '.htm'              = 'html'
    '.html'             = 'html'
    '.ini'              = 'ini'
    '.java'             = 'java'
    '.js'               = 'javascript'
    '.json'             = 'json'
    '.jsx'              = 'jsx'
    '.kt'               = 'kotlin'
    '.less'             = 'less'
    '.lua'              = 'lua'
    '.markdown'         = 'markdown'
    '.md'               = 'markdown'
    '.perl'             = 'perl'
    '.php'              = 'php'
    '.pl'               = 'perl'
    '.ps1'              = 'powershell'
    '.psd1'             = 'powershell'
    '.psm1'             = 'powershell'
    '.py'               = 'python'
    '.r'                = 'r'
    '.rb'               = 'ruby'
    '.rs'               = 'rust'
    '.sass'             = 'sass'
    '.scala'            = 'scala'
    '.scss'             = 'scss'
    '.sh'               = 'bash'
    '.sql'              = 'sql'
    '.swift'            = 'swift'
    '.tex'              = 'latex'
    '.toml'             = 'toml'
    '.ts'               = 'typescript'
    '.tsx'              = 'tsx'
    '.txt'              = 'text'
    '.vim'              = 'vim'
    '.xml'              = 'xml'
    '.yaml'             = 'yaml'
    '.yml'              = 'yaml'
    '.zsh'              = 'bash'
}

#-------------------------------------------------------------------------------
# Main Process
#-------------------------------------------------------------------------------

Write-Host "</span>Generating Prompt Code Reference from project root files...<span class="hljs-string">" -ForegroundColor Green
Write-Host "</span>  Target directory: <span class="hljs-variable">$</span>(<span class="hljs-built_in">Resolve-Path</span> <span class="hljs-literal">-LiteralPath</span> <span class="hljs-variable">$ProjectRoot</span>)<span class="hljs-string">" -ForegroundColor Cyan

# Delete existing output file if it exists to prevent it from being included in processing
if (Test-Path -LiteralPath <span class="hljs-variable">$OutputFile</span>) {
    Remove-Item -LiteralPath <span class="hljs-variable">$OutputFile</span> -Force -ErrorAction SilentlyContinue
}

# Get all files from project root (recursive if -Recurse specified)
# Note: Get-ChildItem without -Force already excludes hidden files by default
<span class="hljs-variable">$GetChildItemParams</span> = @{
    LiteralPath = <span class="hljs-variable">$ProjectRoot</span>
    File = <span class="hljs-variable">$true</span>
}

if (<span class="hljs-variable">$Recurse</span>) {
    <span class="hljs-variable">$GetChildItemParams</span>['Recurse'] = <span class="hljs-variable">$true</span>
}

<span class="hljs-variable">$RootFiles</span> = Get-ChildItem @GetChildItemParams | Where-Object {
    # Exclude files in exclusion list
    if (<span class="hljs-variable">$_</span>.Name -in <span class="hljs-variable">$ExcludedFiles</span>) {
        return <span class="hljs-variable">$false</span>
    }
    # Unless -Force is specified, exclude hidden files and dotfiles
    if (-not <span class="hljs-variable">$Force</span>) {
        # Exclude files with Hidden attribute
        if (<span class="hljs-variable">$_</span>.Attributes -band [System.IO.FileAttributes]::Hidden) {
            return <span class="hljs-variable">$false</span>
        }
        # Exclude dotfiles (files starting with .)
        if (<span class="hljs-variable">$_</span>.Name.StartsWith('.')) {
            return <span class="hljs-variable">$false</span>
        }
    }
    return <span class="hljs-variable">$true</span>
} | Sort-Object Name

if (<span class="hljs-variable">$RootFiles</span>.Count -eq 0) {
    Write-Warning "</span>No files found <span class="hljs-keyword">in</span> project root to process.<span class="hljs-string">"
    exit 1
}

Write-Host "</span>  Found <span class="hljs-variable">$</span>(<span class="hljs-variable">$RootFiles</span>.Count) files to <span class="hljs-keyword">process</span><span class="hljs-string">" -ForegroundColor Cyan

# Initialize output content
<span class="hljs-variable">$MarkdownContent</span> = @()
<span class="hljs-variable">$MarkdownContent</span> += "</span><span class="hljs-comment"># Prompt Code Reference"</span>
<span class="hljs-variable">$MarkdownContent</span> += <span class="hljs-string">""</span>

<span class="hljs-comment"># Check for README file variants and process first</span>
<span class="hljs-comment"># Match: README.md, README (no extension), README.markdown, etc.</span>
<span class="hljs-comment"># Exclude: README.txt (treat as plain text)</span>
<span class="hljs-variable">$ReadmeFile</span> = <span class="hljs-variable">$RootFiles</span> | <span class="hljs-built_in">Where-Object</span> {
    <span class="hljs-variable">$_</span>.BaseName <span class="hljs-operator">-eq</span> <span class="hljs-string">'README'</span> <span class="hljs-operator">-and</span> <span class="hljs-variable">$_</span>.Extension <span class="hljs-operator">-ne</span> <span class="hljs-string">'.txt'</span>
} | <span class="hljs-built_in">Select-Object</span> <span class="hljs-literal">-First</span> <span class="hljs-number">1</span>

<span class="hljs-keyword">if</span> (<span class="hljs-variable">$ReadmeFile</span>) {
    <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"  Processing: <span class="hljs-variable">$</span>(<span class="hljs-variable">$ReadmeFile</span>.FullName) (with header adjustments)..."</span> <span class="hljs-literal">-ForegroundColor</span> Yellow

    <span class="hljs-keyword">try</span> {
        <span class="hljs-variable">$ReadmeContent</span> = <span class="hljs-built_in">Get-Content</span> <span class="hljs-literal">-LiteralPath</span> <span class="hljs-variable">$ReadmeFile</span>.FullName <span class="hljs-literal">-Raw</span> <span class="hljs-literal">-ErrorAction</span> Stop

        <span class="hljs-comment"># Downgrade all headers (deepest first to avoid collisions)</span>
        <span class="hljs-comment"># Level 6 -&gt; 7 (but markdown only supports up to 6, so these become invalid)</span>
        <span class="hljs-comment"># Level 5 -&gt; 6</span>
        <span class="hljs-comment"># Level 4 -&gt; 5</span>
        <span class="hljs-comment"># Level 3 -&gt; 4</span>
        <span class="hljs-comment"># Level 2 -&gt; 3</span>
        <span class="hljs-comment"># Level 1 -&gt; 2</span>
        <span class="hljs-variable">$ReadmeContent</span> = <span class="hljs-variable">$ReadmeContent</span> <span class="hljs-operator">-replace</span> <span class="hljs-string">'(?m)^######\s+'</span>, <span class="hljs-string">'####### '</span>
        <span class="hljs-variable">$ReadmeContent</span> = <span class="hljs-variable">$ReadmeContent</span> <span class="hljs-operator">-replace</span> <span class="hljs-string">'(?m)^#####\s+'</span>, <span class="hljs-string">'###### '</span>
        <span class="hljs-variable">$ReadmeContent</span> = <span class="hljs-variable">$ReadmeContent</span> <span class="hljs-operator">-replace</span> <span class="hljs-string">'(?m)^####\s+'</span>, <span class="hljs-string">'##### '</span>
        <span class="hljs-variable">$ReadmeContent</span> = <span class="hljs-variable">$ReadmeContent</span> <span class="hljs-operator">-replace</span> <span class="hljs-string">'(?m)^###\s+'</span>, <span class="hljs-string">'#### '</span>
        <span class="hljs-variable">$ReadmeContent</span> = <span class="hljs-variable">$ReadmeContent</span> <span class="hljs-operator">-replace</span> <span class="hljs-string">'(?m)^##\s+'</span>, <span class="hljs-string">'### '</span>
        <span class="hljs-variable">$ReadmeContent</span> = <span class="hljs-variable">$ReadmeContent</span> <span class="hljs-operator">-replace</span> <span class="hljs-string">'(?m)^#\s+'</span>, <span class="hljs-string">'## '</span>

        <span class="hljs-comment"># Remove the first level-2 header line only (which was originally level-1)</span>
        <span class="hljs-variable">$ReadmeContent</span> = <span class="hljs-variable">$ReadmeContent</span> <span class="hljs-operator">-replace</span> <span class="hljs-string">'^##\s+[^\r\n]+(\r?\n)?'</span>, <span class="hljs-string">''</span>

        <span class="hljs-comment"># Fix list formatting: Insert blank line before list items that don't follow other list items</span>
        <span class="hljs-comment"># Match lines starting with '-' where the previous line doesn't start with '-' or whitespace+'-'</span>
        <span class="hljs-variable">$ReadmeContent</span> = <span class="hljs-variable">$ReadmeContent</span> <span class="hljs-operator">-replace</span> <span class="hljs-string">'(?m)(?&lt;=^(?!.*\s*-)[^\r\n]+\r?\n)(?=\s*-)'</span>, <span class="hljs-string">"`n"</span>

        <span class="hljs-comment"># Get relative path for README</span>
        <span class="hljs-variable">$RelativePath</span> = <span class="hljs-string">".\<span class="hljs-variable">$</span>(<span class="hljs-variable">$ReadmeFile</span>.Name)"</span>

        <span class="hljs-comment"># Always add README.md as level-2 header at the top with relative path</span>
        <span class="hljs-variable">$ReadmeContent</span> = <span class="hljs-string">"## ``<span class="hljs-variable">$RelativePath</span>```n`n"</span> + <span class="hljs-variable">$ReadmeContent</span>.TrimStart()

        <span class="hljs-comment"># Add the processed README content</span>
        <span class="hljs-variable">$MarkdownContent</span> += <span class="hljs-variable">$ReadmeContent</span>.TrimEnd()
        <span class="hljs-variable">$MarkdownContent</span> += <span class="hljs-string">""</span>
        <span class="hljs-variable">$MarkdownContent</span> += <span class="hljs-string">""</span>
    }
    <span class="hljs-keyword">catch</span> {
        <span class="hljs-built_in">Write-Warning</span> <span class="hljs-string">"Failed to read README.md: <span class="hljs-variable">$_</span>"</span>
    }
}

<span class="hljs-comment"># Process all other files (excluding README variants)</span>
<span class="hljs-variable">$OtherFiles</span> = <span class="hljs-variable">$RootFiles</span> | <span class="hljs-built_in">Where-Object</span> {
    <span class="hljs-operator">-not</span> (<span class="hljs-variable">$_</span>.BaseName <span class="hljs-operator">-eq</span> <span class="hljs-string">'README'</span> <span class="hljs-operator">-and</span> <span class="hljs-variable">$_</span>.Extension <span class="hljs-operator">-ne</span> <span class="hljs-string">'.txt'</span>)
}

<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$File</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$OtherFiles</span>) {
    <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"  Processing: <span class="hljs-variable">$</span>(<span class="hljs-variable">$File</span>.FullName)"</span> <span class="hljs-literal">-ForegroundColor</span> Yellow

    <span class="hljs-comment"># Calculate relative path from project root</span>
    <span class="hljs-variable">$FullProjectRoot</span> = (<span class="hljs-built_in">Resolve-Path</span> <span class="hljs-literal">-LiteralPath</span> <span class="hljs-variable">$ProjectRoot</span>).Path
    <span class="hljs-variable">$FullFilePath</span> = <span class="hljs-variable">$File</span>.FullName

    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$FullFilePath</span>.StartsWith(<span class="hljs-variable">$FullProjectRoot</span>)) {
        <span class="hljs-variable">$RelativePath</span> = <span class="hljs-variable">$FullFilePath</span>.Substring(<span class="hljs-variable">$FullProjectRoot</span>.Length).TrimStart(<span class="hljs-string">'\'</span>, <span class="hljs-string">'/'</span>)
        <span class="hljs-variable">$RelativePath</span> = <span class="hljs-string">".\<span class="hljs-variable">$RelativePath</span>"</span>
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable">$RelativePath</span> = <span class="hljs-string">".\<span class="hljs-variable">$</span>(<span class="hljs-variable">$File</span>.Name)"</span>
    }

    <span class="hljs-comment"># Check if this is a Markdown file (excluding README.md which is already processed)</span>
    <span class="hljs-variable">$IsMarkdown</span> = <span class="hljs-variable">$File</span>.Extension <span class="hljs-operator">-eq</span> <span class="hljs-string">'.md'</span>

    <span class="hljs-comment"># If it's a Markdown file and -IncludeMarkdown is NOT specified, add placeholder</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$IsMarkdown</span> <span class="hljs-operator">-and</span> <span class="hljs-operator">-not</span> <span class="hljs-variable">$IncludeMarkdown</span>) {
        <span class="hljs-variable">$MarkdownContent</span> += <span class="hljs-string">"## ``<span class="hljs-variable">$RelativePath</span>``"</span>
        <span class="hljs-variable">$MarkdownContent</span> += <span class="hljs-string">""</span>
        <span class="hljs-variable">$MarkdownContent</span> += <span class="hljs-string">"(All non-readme markdown content is excluded by default from this project summary document.)"</span>
        <span class="hljs-variable">$MarkdownContent</span> += <span class="hljs-string">""</span>
        <span class="hljs-keyword">continue</span>
    }

    <span class="hljs-comment"># Determine syntax highlighting language</span>
    <span class="hljs-variable">$Extension</span> = <span class="hljs-variable">$File</span>.Extension.ToLower()
    <span class="hljs-variable">$Language</span> = <span class="hljs-keyword">if</span> (<span class="hljs-variable">$SyntaxMap</span>.ContainsKey(<span class="hljs-variable">$Extension</span>)) {
        <span class="hljs-variable">$SyntaxMap</span>[<span class="hljs-variable">$Extension</span>]
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-string">'text'</span>
    }

    <span class="hljs-comment"># Read file content</span>
    <span class="hljs-keyword">try</span> {
        <span class="hljs-variable">$FileContent</span> = <span class="hljs-built_in">Get-Content</span> <span class="hljs-literal">-LiteralPath</span> <span class="hljs-variable">$File</span>.FullName <span class="hljs-literal">-Raw</span> <span class="hljs-literal">-ErrorAction</span> Stop

        <span class="hljs-comment"># If this is a Markdown file (and -IncludeMarkdown was specified), process headers</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$IsMarkdown</span>) {
            <span class="hljs-comment"># Downgrade all headers (deepest first to avoid collisions)</span>
            <span class="hljs-variable">$FileContent</span> = <span class="hljs-variable">$FileContent</span> <span class="hljs-operator">-replace</span> <span class="hljs-string">'(?m)^######\s+'</span>, <span class="hljs-string">'####### '</span>
            <span class="hljs-variable">$FileContent</span> = <span class="hljs-variable">$FileContent</span> <span class="hljs-operator">-replace</span> <span class="hljs-string">'(?m)^#####\s+'</span>, <span class="hljs-string">'###### '</span>
            <span class="hljs-variable">$FileContent</span> = <span class="hljs-variable">$FileContent</span> <span class="hljs-operator">-replace</span> <span class="hljs-string">'(?m)^####\s+'</span>, <span class="hljs-string">'##### '</span>
            <span class="hljs-variable">$FileContent</span> = <span class="hljs-variable">$FileContent</span> <span class="hljs-operator">-replace</span> <span class="hljs-string">'(?m)^###\s+'</span>, <span class="hljs-string">'#### '</span>
            <span class="hljs-variable">$FileContent</span> = <span class="hljs-variable">$FileContent</span> <span class="hljs-operator">-replace</span> <span class="hljs-string">'(?m)^##\s+'</span>, <span class="hljs-string">'### '</span>
            <span class="hljs-variable">$FileContent</span> = <span class="hljs-variable">$FileContent</span> <span class="hljs-operator">-replace</span> <span class="hljs-string">'(?m)^#\s+'</span>, <span class="hljs-string">'## '</span>

            <span class="hljs-comment"># Remove the first level-2 header line only (which was originally level-1)</span>
            <span class="hljs-variable">$FileContent</span> = <span class="hljs-variable">$FileContent</span> <span class="hljs-operator">-replace</span> <span class="hljs-string">'^##\s+[^\r\n]+(\r?\n)?'</span>, <span class="hljs-string">''</span>

            <span class="hljs-comment"># Fix list formatting: Insert blank line before list items that don't follow other list items</span>
            <span class="hljs-comment"># Match lines starting with '-' where the previous line doesn't start with '-' or whitespace+'-'</span>
            <span class="hljs-variable">$FileContent</span> = <span class="hljs-variable">$FileContent</span> <span class="hljs-operator">-replace</span> <span class="hljs-string">'(?m)(?&lt;=^(?!.*\s*-)[^\r\n]+\r?\n)(?=\s*-)'</span>, <span class="hljs-string">"`n"</span>

            <span class="hljs-comment"># Add header with relative path and processed content</span>
            <span class="hljs-variable">$MarkdownContent</span> += <span class="hljs-string">"## ``<span class="hljs-variable">$RelativePath</span>``"</span>
            <span class="hljs-variable">$MarkdownContent</span> += <span class="hljs-string">""</span>
            <span class="hljs-variable">$MarkdownContent</span> += <span class="hljs-variable">$FileContent</span>.TrimStart().TrimEnd()
            <span class="hljs-variable">$MarkdownContent</span> += <span class="hljs-string">""</span>
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment"># Add header and code block with relative path in backticks</span>
            <span class="hljs-variable">$MarkdownContent</span> += <span class="hljs-string">"## ``<span class="hljs-variable">$RelativePath</span>``"</span>
            <span class="hljs-variable">$MarkdownContent</span> += <span class="hljs-string">""</span>
            <span class="hljs-variable">$MarkdownContent</span> += <span class="hljs-string">"``````<span class="hljs-variable">$Language</span>"</span>
            <span class="hljs-variable">$MarkdownContent</span> += <span class="hljs-variable">$FileContent</span>.TrimEnd()
            <span class="hljs-variable">$MarkdownContent</span> += <span class="hljs-string">"``````"</span>
            <span class="hljs-variable">$MarkdownContent</span> += <span class="hljs-string">""</span>
        }
    }
    <span class="hljs-keyword">catch</span> {
        <span class="hljs-built_in">Write-Warning</span> <span class="hljs-string">"Failed to read file: <span class="hljs-variable">$</span>(<span class="hljs-variable">$File</span>.Name) - <span class="hljs-variable">$_</span>"</span>
        <span class="hljs-keyword">continue</span>
    }
}

<span class="hljs-comment"># Write output file (force clobber if exists)</span>
<span class="hljs-keyword">try</span> {
    <span class="hljs-variable">$FinalContent</span> = (<span class="hljs-variable">$MarkdownContent</span> <span class="hljs-operator">-join</span> <span class="hljs-string">"`n"</span>)

    <span class="hljs-comment"># Replace three sequential line breaks with two line breaks</span>
    <span class="hljs-variable">$FinalContent</span> = <span class="hljs-variable">$FinalContent</span> <span class="hljs-operator">-replace</span> <span class="hljs-string">'(\r?\n){3}'</span>, <span class="hljs-string">"`n`n"</span>

    <span class="hljs-variable">$FinalContent</span> | <span class="hljs-built_in">Set-Content</span> <span class="hljs-literal">-LiteralPath</span> <span class="hljs-variable">$OutputFile</span> <span class="hljs-literal">-NoNewline</span> <span class="hljs-literal">-Encoding</span> UTF8 <span class="hljs-literal">-Force</span> <span class="hljs-literal">-ErrorAction</span> Stop
    <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">""</span>
    <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"Successfully generated: <span class="hljs-variable">$OutputFile</span>"</span> <span class="hljs-literal">-ForegroundColor</span> Green
    <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"  Total files processed: <span class="hljs-variable">$</span>(<span class="hljs-variable">$RootFiles</span>.Count)"</span> <span class="hljs-literal">-ForegroundColor</span> Cyan
}
<span class="hljs-keyword">catch</span> {
    <span class="hljs-built_in">Write-Error</span> <span class="hljs-string">"Failed to write output file: <span class="hljs-variable">$_</span>"</span>
    <span class="hljs-keyword">exit</span> <span class="hljs-number">1</span>
}
</div></code></pre>
<h2 id="binshimspipbat"><code>.\bin\shims\pip.bat</code></h2>
<pre class="hljs"><code><div>@echo off
setlocal
REM ensure pip matches whatever python.bat resolved
&quot;%~dp0python.bat&quot; -m pip %*
</div></code></pre>
<h2 id="examplesprofileps1"><code>.\examples\profile.ps1</code></h2>
<pre class="hljs"><code><div><span class="hljs-comment"># Quiet verbose unless you explicitly opt in later</span>
<span class="hljs-variable">$VerbosePreference</span> = <span class="hljs-string">'SilentlyContinue'</span>

<span class="hljs-comment"># ===== ShruggieTech Python Shim Profile =====</span>
<span class="hljs-comment"># Ensures the shim is first on PATH and loads helper functions</span>

<span class="hljs-comment"># --- 1) PATH: ensure C:\bin\shims is first and unique</span>
<span class="hljs-variable">$ShimDir</span> = <span class="hljs-string">'C:\bin\shims'</span>

<span class="hljs-comment"># Bridge for when Windows Launcher is missing</span>
<span class="hljs-keyword">if</span> (<span class="hljs-operator">-not</span> (<span class="hljs-built_in">Get-Command</span> py <span class="hljs-literal">-ErrorAction</span> SilentlyContinue)) {
    <span class="hljs-built_in">Set-Alias</span> py <span class="hljs-string">"<span class="hljs-variable">$ShimDir</span>\python.bat"</span> <span class="hljs-literal">-Scope</span> Global
}

<span class="hljs-comment"># Split PATH into parts, remove empties, sort and unique</span>
<span class="hljs-variable">$pathParts</span> = (<span class="hljs-variable">$env:PATH</span> <span class="hljs-operator">-split</span> <span class="hljs-string">';'</span>) | <span class="hljs-built_in">Where-Object</span> { <span class="hljs-variable">$_</span> <span class="hljs-operator">-and</span> <span class="hljs-variable">$_</span>.Trim() <span class="hljs-operator">-ne</span> <span class="hljs-string">''</span> } | <span class="hljs-built_in">Sort-Object</span> <span class="hljs-literal">-Unique</span>

<span class="hljs-comment"># Remove all occurrences of ShimDir</span>
<span class="hljs-variable">$pathParts</span> = <span class="hljs-variable">$pathParts</span> | <span class="hljs-built_in">Where-Object</span> { <span class="hljs-variable">$_</span> <span class="hljs-operator">-ne</span> <span class="hljs-variable">$ShimDir</span> }

<span class="hljs-comment"># Prepend ShimDir</span>
<span class="hljs-variable">$env:PATH</span> = (<span class="hljs-variable">$ShimDir</span> + <span class="hljs-string">';'</span> + (<span class="hljs-variable">$pathParts</span> <span class="hljs-operator">-join</span> <span class="hljs-string">';'</span>))

<span class="hljs-comment"># Optional: make sure pipx shims are reachable</span>
<span class="hljs-variable">$PipxBin</span> = <span class="hljs-built_in">Join-Path</span> <span class="hljs-variable">$env:USERPROFILE</span> <span class="hljs-string">'.local\bin'</span>
<span class="hljs-keyword">if</span> (<span class="hljs-operator">-not</span> (<span class="hljs-variable">$env:PATH</span> <span class="hljs-operator">-split</span> <span class="hljs-string">';'</span> | <span class="hljs-built_in">Where-Object</span> { <span class="hljs-variable">$_</span> <span class="hljs-operator">-eq</span> <span class="hljs-variable">$PipxBin</span> })) {
    <span class="hljs-variable">$env:PATH</span> = <span class="hljs-string">"<span class="hljs-variable">$PipxBin</span>;<span class="hljs-variable">$env:PATH</span>"</span>
}

<span class="hljs-comment"># --- 2) Import pyshim module (provides Use-Python, Set-AppPython, etc.)</span>
<span class="hljs-variable">$PyShimModule</span> = <span class="hljs-built_in">Join-Path</span> <span class="hljs-variable">$ShimDir</span> <span class="hljs-string">'pyshim.psm1'</span>
<span class="hljs-keyword">if</span> (<span class="hljs-built_in">Test-Path</span> <span class="hljs-literal">-LiteralPath</span> <span class="hljs-variable">$PyShimModule</span>) {
    <span class="hljs-built_in">Import-Module</span> <span class="hljs-variable">$PyShimModule</span> <span class="hljs-literal">-Force</span> <span class="hljs-literal">-DisableNameChecking</span>
} <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">Write-Warning</span> <span class="hljs-string">"pyshim module not found at <span class="hljs-variable">$PyShimModule</span>. Install shims and module from repo."</span>
}

<span class="hljs-comment"># --- 3) DO NOT override the Windows 'py' launcher</span>
<span class="hljs-comment"># If you previously had: New-Alias py python  =&gt; REMOVE IT.</span>
<span class="hljs-comment"># The py launcher is used by specs like 'py:3.12' and must remain available.</span>

<span class="hljs-comment"># --- 4) Friendly helpers ------------------------------------------------------</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Show-PyShim</span></span> {
    <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"PATH[0] = <span class="hljs-variable">$ShimDir</span>"</span>
    <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"pyshim module loaded: "</span> <span class="hljs-literal">-NoNewline</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Get-Module</span> <span class="hljs-literal">-Name</span> (<span class="hljs-built_in">Split-Path</span> <span class="hljs-variable">$PyShimModule</span> <span class="hljs-literal">-Leaf</span>) <span class="hljs-literal">-ErrorAction</span> SilentlyContinue) {
        <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"yes"</span>
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"no"</span>
    }

    <span class="hljs-variable">$globalEnv</span> = <span class="hljs-built_in">Join-Path</span> <span class="hljs-variable">$ShimDir</span> <span class="hljs-string">'python.env'</span>
    <span class="hljs-variable">$nopersist</span> = <span class="hljs-built_in">Join-Path</span> <span class="hljs-variable">$ShimDir</span> <span class="hljs-string">'python.nopersist'</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Test-Path</span> <span class="hljs-variable">$globalEnv</span>) {
        <span class="hljs-variable">$spec</span> = <span class="hljs-built_in">Get-Content</span> <span class="hljs-literal">-LiteralPath</span> <span class="hljs-variable">$globalEnv</span> <span class="hljs-literal">-Raw</span>
        <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"Global spec (python.env): <span class="hljs-variable">$spec</span>"</span>
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"Global spec (python.env): &lt;none&gt;"</span>
    }
    <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"Global persistence disabled? "</span> <span class="hljs-literal">-NoNewline</span>
    <span class="hljs-built_in">Write-Host</span> (<span class="hljs-variable">$</span>(<span class="hljs-built_in">Test-Path</span> <span class="hljs-variable">$nopersist</span>))
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$env:PYSHIM_INTERPRETER</span>) { <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"Session spec: <span class="hljs-variable">$</span>(<span class="hljs-variable">$env:PYSHIM_INTERPRETER</span>)"</span> }
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$env:PYSHIM_TARGET</span>)      { <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"App target : <span class="hljs-variable">$</span>(<span class="hljs-variable">$env:PYSHIM_TARGET</span>)"</span> }
}

<span class="hljs-comment"># A quick bootstrap: if you want a default interpreter for new shells but not when nopersist is set</span>
<span class="hljs-variable">$DefaultSpec</span> = <span class="hljs-variable">$null</span>   <span class="hljs-comment"># e.g. 'py:3.12' or 'conda:base'  (leave $null to do nothing)</span>
<span class="hljs-variable">$NoPersistMarker</span> = <span class="hljs-built_in">Join-Path</span> <span class="hljs-variable">$ShimDir</span> <span class="hljs-string">'python.nopersist'</span>
<span class="hljs-variable">$GlobalEnvFile</span>  = <span class="hljs-built_in">Join-Path</span> <span class="hljs-variable">$ShimDir</span> <span class="hljs-string">'python.env'</span>

<span class="hljs-keyword">if</span> (<span class="hljs-variable">$DefaultSpec</span> <span class="hljs-operator">-and</span> <span class="hljs-operator">-not</span> (<span class="hljs-built_in">Test-Path</span> <span class="hljs-variable">$NoPersistMarker</span>) <span class="hljs-operator">-and</span> <span class="hljs-operator">-not</span> (<span class="hljs-built_in">Test-Path</span> <span class="hljs-variable">$GlobalEnvFile</span>)) {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-built_in">Use-Python</span> <span class="hljs-literal">-Spec</span> <span class="hljs-variable">$DefaultSpec</span> <span class="hljs-literal">-Persist</span>
        <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"Initialized global Python spec -&gt; <span class="hljs-variable">$DefaultSpec</span>"</span>
    } <span class="hljs-keyword">catch</span> {
        <span class="hljs-built_in">Write-Warning</span> <span class="hljs-string">"Failed to initialize global Python spec: <span class="hljs-variable">$</span>(<span class="hljs-variable">$_</span>.Exception.Message)"</span>
    }
}

<span class="hljs-comment"># --- 5) Conda wrapper that cooperates with pyshim -----------------------------</span>
<span class="hljs-comment"># When you run: conda activate &lt;env&gt;, set only the *session* spec to that env.</span>
<span class="hljs-comment"># This keeps the shell consistent without flipping global persistence.</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">conda</span></span> {
    <span class="hljs-comment"># Call the real conda</span>
    <span class="hljs-variable">$RealConda</span> = <span class="hljs-built_in">Join-Path</span> <span class="hljs-variable">$env:USERPROFILE</span> <span class="hljs-string">'miniconda3\Scripts\conda.exe'</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-operator">-not</span> (<span class="hljs-built_in">Test-Path</span> <span class="hljs-literal">-LiteralPath</span> <span class="hljs-variable">$RealConda</span>)) {
        <span class="hljs-built_in">Write-Error</span> <span class="hljs-string">"Conda not found at <span class="hljs-variable">$RealConda</span>"</span>; <span class="hljs-keyword">return</span>
    }
    &amp; <span class="hljs-variable">$RealConda</span> @Args

    <span class="hljs-comment"># Detect "conda activate &lt;env&gt;"</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$Args</span>.Count <span class="hljs-operator">-ge</span> <span class="hljs-number">2</span> <span class="hljs-operator">-and</span> <span class="hljs-variable">$Args</span>[<span class="hljs-number">0</span>] <span class="hljs-operator">-eq</span> <span class="hljs-string">'activate'</span>) {
        <span class="hljs-variable">$envName</span> = <span class="hljs-variable">$Args</span>[<span class="hljs-number">1</span>]
        <span class="hljs-comment"># Session-only switch to that env</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-built_in">Use-Python</span> <span class="hljs-literal">-Spec</span> <span class="hljs-string">"conda:<span class="hljs-variable">$envName</span>"</span>
            <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"Session Python -&gt; conda:<span class="hljs-variable">$envName</span> (not persisted)"</span>
        } <span class="hljs-keyword">catch</span> {
            <span class="hljs-built_in">Write-Warning</span> (<span class="hljs-string">"Failed to set session interpreter to conda:<span class="hljs-variable">$</span>(<span class="hljs-variable">$envName</span>): <span class="hljs-variable">$</span>(<span class="hljs-variable">$_</span>.Exception.Message)"</span>)
        }
    }
}

<span class="hljs-comment"># --- 6) Convenience: quick commands ------------------------------------------</span>
<span class="hljs-built_in">Set-Alias</span> which <span class="hljs-built_in">Get-Command</span> <span class="hljs-literal">-Scope</span> Global <span class="hljs-literal">-ErrorAction</span> SilentlyContinue

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pyver</span></span> { &amp; <span class="hljs-string">"<span class="hljs-variable">$ShimDir</span>\python.bat"</span> <span class="hljs-literal">-V</span> }
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pipver</span></span> { &amp; <span class="hljs-string">"<span class="hljs-variable">$ShimDir</span>\python.bat"</span> <span class="hljs-literal">-m</span> pip -<span class="hljs-literal">-version</span> }

<span class="hljs-comment"># Uncomment if you want to see current shim state on every new shell</span>
<span class="hljs-comment"># Show-PyShim</span>
</div></code></pre>
<h2 id="pyshimcode-workspace"><code>.\pyshim.code-workspace</code></h2>
<pre class="hljs"><code><div>{
    <span class="hljs-attr">"folders"</span>: [
        {
            <span class="hljs-attr">"name"</span>: <span class="hljs-string">"pyshim"</span>,
            <span class="hljs-attr">"path"</span>: <span class="hljs-string">"."</span>
        }
    ],
    <span class="hljs-attr">"settings"</span>: {
        <span class="hljs-attr">"powershell.cwd"</span>: <span class="hljs-string">"pyshim"</span>,
        <span class="hljs-attr">"powershell.buttons.showPanelMovementButtons"</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">"powershell.enableReferencesCodeLens"</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">"powershell.codeFormatting.autoCorrectAliases"</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">"powershell.codeFormatting.avoidSemicolonsAsLineTerminators"</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">"powershell.codeFormatting.ignoreOneLineBlock"</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">"powershell.codeFormatting.openBraceOnSameLine"</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">"powershell.codeFormatting.whitespaceAfterSeparator"</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">"powershell.codeFormatting.whitespaceAroundOperator"</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">"powershell.codeFormatting.whitespaceBeforeOpenParen"</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">"powershell.analyzeOpenDocumentsOnly"</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">"editor.foldingStrategy"</span>: <span class="hljs-string">"indentation"</span>,
        <span class="hljs-comment">/*"editor.defaultFormatter": "ms-vscode.powershell",*/</span>
        <span class="hljs-attr">"editor.formatOnSave"</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">"editor.tabSize"</span>: <span class="hljs-number">4</span>,
        <span class="hljs-attr">"editor.insertSpaces"</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">"editor.detectIndentation"</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">"editor.wordWrap"</span>: <span class="hljs-string">"on"</span>,
        <span class="hljs-attr">"editor.minimap.enabled"</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">"editor.renderWhitespace"</span>: <span class="hljs-string">"all"</span>,
        <span class="hljs-attr">"editor.renderControlCharacters"</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">"editor.renderLineHighlight"</span>: <span class="hljs-string">"all"</span>,
        <span class="hljs-attr">"editor.renderFinalNewline"</span>: <span class="hljs-string">"on"</span>,
        <span class="hljs-attr">"editor.rulers"</span>: [
            <span class="hljs-number">80</span>,
            <span class="hljs-number">84</span>,
            <span class="hljs-number">88</span>,
            <span class="hljs-number">120</span>,
            <span class="hljs-number">124</span>,
            <span class="hljs-number">128</span>,
            <span class="hljs-number">160</span>
        ],
        <span class="hljs-attr">"editor.codeLens"</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">"editor.fontSize"</span>: <span class="hljs-number">12</span>,
        <span class="hljs-attr">"editor.fontLigatures"</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">"editor.lineHeight"</span>: <span class="hljs-number">20</span>,
        <span class="hljs-attr">"editor.letterSpacing"</span>: <span class="hljs-number">0.6</span>,
        <span class="hljs-attr">"editor.cursorBlinking"</span>: <span class="hljs-string">"smooth"</span>,
        <span class="hljs-attr">"editor.cursorSmoothCaretAnimation"</span>: <span class="hljs-string">"on"</span>,
        <span class="hljs-attr">"editor.cursorStyle"</span>: <span class="hljs-string">"line"</span>,
        <span class="hljs-attr">"editor.cursorWidth"</span>: <span class="hljs-number">2</span>,
        <span class="hljs-attr">"editor.cursorSurroundingLines"</span>: <span class="hljs-number">3</span>,
        <span class="hljs-attr">"editor.cursorSurroundingLinesStyle"</span>: <span class="hljs-string">"default"</span>,
        <span class="hljs-attr">"editor.hover.delay"</span>: <span class="hljs-number">3000</span>,
        <span class="hljs-attr">"workbench.hover.delay"</span>: <span class="hljs-number">3000</span>,
        <span class="hljs-attr">"workbench.sash.hoverDelay"</span>: <span class="hljs-number">2000</span>,
        <span class="hljs-attr">"inlineChat.lineEmptyHint"</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">"json.format.enable"</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">"json.validate.enable"</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">"json.schemas"</span>: [
            {
                <span class="hljs-attr">"fileMatch"</span>: [
                    <span class="hljs-string">"manifest.json"</span>,
                    <span class="hljs-string">"manifest.webmanifest"</span>,
                    <span class="hljs-string">"app.webmanifest"</span>
                ],
                <span class="hljs-attr">"url"</span>: <span class="hljs-string">"https://json.schemastore.org/web-manifest.json"</span>
            },{
                <span class="hljs-attr">"fileMatch"</span>: [
                    <span class="hljs-string">"*_meta.json"</span>,
                    <span class="hljs-string">"*_directorymeta.json"</span>,
                    <span class="hljs-string">"*-feeds-export_index.json"</span>
                ],
                <span class="hljs-attr">"url"</span>: <span class="hljs-string">"https://cdn.h8rt3rmin8r.com/schemas/MakeIndex.meta.json"</span>
            }
        ],
        <span class="hljs-attr">"[powershell]"</span>: {
            <span class="hljs-attr">"editor.defaultFormatter"</span>: <span class="hljs-string">"ms-vscode.powershell"</span>
        },
        <span class="hljs-attr">"[log]"</span>: {
            <span class="hljs-attr">"editor.wordWrap"</span>: <span class="hljs-string">"off"</span>
        }
    }
}
</div></code></pre>
<h2 id="binshimspyshimpsm1"><code>.\bin\shims\pyshim.psm1</code></h2>
<pre class="hljs"><code><div><span class="hljs-comment"># Save this file here: C:\bin\shims\pyshim.psm1</span>
<span class="hljs-comment"># Import this file from your $PROFILE in Powershell</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Use-Python</span></span> {
    <span class="hljs-comment">&lt;#
    <span class="hljs-doctag">.SYNOPSIS</span>
        Choose a Python interpreter for this session and/or persist it globally.
    <span class="hljs-doctag">.DESCRIPTION</span>
        SPEC accepts absolute path, 'py:3.12', 'py:3', or 'conda:ENV'.
    <span class="hljs-doctag">.PARAMETER Spec</span>
        Interpreter spec.
    <span class="hljs-doctag">.PARAMETER Persist</span>
        Write SPEC to C:\bin\shims\python.env (unless nopersist marker exists).
    <span class="hljs-doctag">.PARAMETER NoPersist</span>
        Delete C:\bin\shims\python.env (session keeps $env:PYSHIM_INTERPRETER only).
    <span class="hljs-doctag">.EXAMPLE</span>
        Use-Python -Spec 'py:3.12' -Persist
    <span class="hljs-doctag">.EXAMPLE</span>
        Use-Python -Spec 'conda:tools'   # session-only
    #&gt;</span>
    <span class="hljs-function">[<span class="hljs-type">CmdletBinding</span>()]</span>
    <span class="hljs-keyword">Param</span>(
        [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$false</span>)]
        [<span class="hljs-type">System.String</span>]<span class="hljs-variable">$Spec</span>,

        [<span class="hljs-type">Switch</span>]<span class="hljs-variable">$Persist</span>,

        [<span class="hljs-type">Switch</span>]<span class="hljs-variable">$NoPersist</span>
    )

    <span class="hljs-variable">$ShimDir</span> = <span class="hljs-string">'C:\bin\shims'</span>
    <span class="hljs-variable">$GlobalEnv</span> = <span class="hljs-built_in">Join-Path</span> <span class="hljs-variable">$ShimDir</span> <span class="hljs-string">'python.env'</span>
    <span class="hljs-variable">$NoPersistMarker</span> = <span class="hljs-built_in">Join-Path</span> <span class="hljs-variable">$ShimDir</span> <span class="hljs-string">'python.nopersist'</span>

    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$NoPersist</span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Test-Path</span> <span class="hljs-variable">$GlobalEnv</span>) { <span class="hljs-built_in">Remove-Item</span> <span class="hljs-literal">-LiteralPath</span> <span class="hljs-variable">$GlobalEnv</span> <span class="hljs-literal">-Force</span> }
        <span class="hljs-variable">$env:PYSHIM_INTERPRETER</span> = <span class="hljs-variable">$null</span>
        <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"Global persistence disabled for future calls (file removed)."</span> <span class="hljs-literal">-ForegroundColor</span> Yellow
        <span class="hljs-keyword">return</span>
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$Spec</span>) {
        <span class="hljs-variable">$env:PYSHIM_INTERPRETER</span> = <span class="hljs-variable">$Spec</span>
        <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"Session interpreter -&gt; <span class="hljs-variable">$Spec</span>"</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$Persist</span>) {
            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Test-Path</span> <span class="hljs-variable">$NoPersistMarker</span>) {
                <span class="hljs-built_in">Write-Warning</span> <span class="hljs-string">"Global nopersist marker is present; not writing python.env."</span>
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-built_in">Set-Content</span> <span class="hljs-literal">-LiteralPath</span> <span class="hljs-variable">$GlobalEnv</span> <span class="hljs-literal">-Value</span> <span class="hljs-variable">$Spec</span> <span class="hljs-literal">-NoNewline</span> <span class="hljs-literal">-Encoding</span> ASCII
                <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"Persisted globally -&gt; <span class="hljs-variable">$GlobalEnv</span>"</span>
            }
        }
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Test-Path</span> <span class="hljs-variable">$GlobalEnv</span>) {
            <span class="hljs-variable">$env:PYSHIM_INTERPRETER</span> = <span class="hljs-built_in">Get-Content</span> <span class="hljs-literal">-LiteralPath</span> <span class="hljs-variable">$GlobalEnv</span> <span class="hljs-literal">-Raw</span>
            <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"Session now matching global -&gt; <span class="hljs-variable">$</span>(<span class="hljs-variable">$env:PYSHIM_INTERPRETER</span>)"</span>
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"No SPEC provided and no global python.env; using shim fallbacks."</span>
        }
    }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Disable-PythonPersistence</span></span> {
    <span class="hljs-comment">&lt;#
    <span class="hljs-doctag">.SYNOPSIS</span>
        Make shim ignore python.env without deleting it.
    #&gt;</span>
    <span class="hljs-function">[<span class="hljs-type">CmdletBinding</span>()]</span>
    <span class="hljs-keyword">Param</span>()
    <span class="hljs-variable">$marker</span> = <span class="hljs-string">'C:\bin\shims\python.nopersist'</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-operator">-not</span> (<span class="hljs-built_in">Test-Path</span> <span class="hljs-variable">$marker</span>)) { <span class="hljs-built_in">New-Item</span> <span class="hljs-literal">-ItemType</span> File <span class="hljs-literal">-Path</span> <span class="hljs-variable">$marker</span> | <span class="hljs-built_in">Out-Null</span> }
    <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"Created <span class="hljs-variable">$marker</span>. Global persistence is now ignored."</span>
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Enable-PythonPersistence</span></span> {
    <span class="hljs-comment">&lt;#
    <span class="hljs-doctag">.SYNOPSIS</span>
        Re-enable reading python.env.
    #&gt;</span>
    <span class="hljs-function">[<span class="hljs-type">CmdletBinding</span>()]</span>
    <span class="hljs-keyword">Param</span>()
    <span class="hljs-variable">$marker</span> = <span class="hljs-string">'C:\bin\shims\python.nopersist'</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Test-Path</span> <span class="hljs-variable">$marker</span>) { <span class="hljs-built_in">Remove-Item</span> <span class="hljs-literal">-LiteralPath</span> <span class="hljs-variable">$marker</span> <span class="hljs-literal">-Force</span> }
    <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"Removed nopersist marker. Global persistence active again."</span>
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Set-AppPython</span></span> {
    <span class="hljs-comment">&lt;#
    <span class="hljs-doctag">.SYNOPSIS</span>
        Pin an interpreter SPEC for a named app (used when PYSHIM_TARGET=App).
    <span class="hljs-doctag">.EXAMPLE</span>
        Set-AppPython -App 'MyService' -Spec 'conda:svc'
    #&gt;</span>
    <span class="hljs-function">[<span class="hljs-type">CmdletBinding</span>(<span class="hljs-type">SupportsShouldProcess</span>=<span class="hljs-variable">$true</span>)]</span>
    <span class="hljs-keyword">Param</span>(
        [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$true</span>)]
        [<span class="hljs-type">System.String</span>]<span class="hljs-variable">$App</span>,

        [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$true</span>)]
        [<span class="hljs-type">System.String</span>]<span class="hljs-variable">$Spec</span>
    )
    <span class="hljs-variable">$file</span> = <span class="hljs-string">"C:\bin\shims\python@<span class="hljs-variable">$App</span>.env"</span>
    <span class="hljs-built_in">Set-Content</span> <span class="hljs-literal">-LiteralPath</span> <span class="hljs-variable">$file</span> <span class="hljs-literal">-Value</span> <span class="hljs-variable">$Spec</span> <span class="hljs-literal">-NoNewline</span> <span class="hljs-literal">-Encoding</span> ASCII
    <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"Wrote <span class="hljs-variable">$file</span> =&gt; <span class="hljs-variable">$Spec</span>"</span>
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Run-WithPython</span></span> {
    <span class="hljs-comment">&lt;#
    <span class="hljs-doctag">.SYNOPSIS</span>
        One-shot run with a specific interpreter, no persistence.
    <span class="hljs-doctag">.EXAMPLE</span>
        Run-WithPython -Spec 'py:3.11' -- -m pip --version
    #&gt;</span>
    <span class="hljs-function">[<span class="hljs-type">CmdletBinding</span>()]</span>
    <span class="hljs-keyword">Param</span>(
        [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$true</span>)]
        [<span class="hljs-type">System.String</span>]<span class="hljs-variable">$Spec</span>,

        [<span class="hljs-type">Parameter</span>(<span class="hljs-type">ValueFromRemainingArguments</span>=<span class="hljs-variable">$true</span>)]
        [<span class="hljs-built_in">string</span>[]]<span class="hljs-variable">$Args</span>
    )
    &amp; <span class="hljs-string">"C:\bin\shims\python.bat"</span> -<span class="hljs-literal">-interpreter</span> <span class="hljs-string">"<span class="hljs-variable">$Spec</span>"</span> -- @Args
}
</div></code></pre>
<h2 id="binshimspythonbat"><code>.\bin\shims\python.bat</code></h2>
<pre class="hljs"><code><div>@echo off
REM Guard against recursion if PATH is reordered or shim calls itself
if &quot;%PYSHIM_INVOKING%&quot;==&quot;1&quot; exit /b 1
set &quot;PYSHIM_INVOKING=1&quot;

setlocal ENABLEDELAYEDEXPANSION
REM PYSHIM: central resolver for python on Windows (recursion-safe)

set &quot;SHIMDIR=%~dp0&quot;
set &quot;GLOBAL_ENV=%SHIMDIR%python.env&quot;
set &quot;GLOBAL_NOPERSIST=%SHIMDIR%python.nopersist&quot;

REM 0) One-shot flag: --interpreter &quot;SPEC&quot; --
set &quot;ONESHOT_SPEC=&quot;
if /I &quot;%~1&quot;==&quot;--interpreter&quot; (
  if /I &quot;%~3&quot;==&quot;--&quot; (
    set &quot;ONESHOT_SPEC=%~2&quot;
    shift &amp; shift &amp; shift
  )
)

REM --- helpers -------------------------------------------------------
REM Resolve a SPEC (absolute path, conda:ENV, py:VER, plain)
set &quot;RESOLVED_CMD=&quot;
call :RESOLVE_SPEC &quot;%ONESHOT_SPEC%&quot; RESOLVED_CMD
if defined RESOLVED_CMD goto :RUN

REM 1) Session override
if defined PYSHIM_INTERPRETER (
  call :RESOLVE_SPEC &quot;%PYSHIM_INTERPRETER%&quot; RESOLVED_CMD
  if defined RESOLVED_CMD goto :RUN
)

REM 2) App-target override
if defined PYSHIM_TARGET (
  set &quot;TARGET_ENV=%SHIMDIR%python@%PYSHIM_TARGET%.env&quot;
  if exist &quot;%TARGET_ENV%&quot; (
    for /f &quot;usebackq delims=&quot; %%P in (&quot;%TARGET_ENV%&quot;) do set &quot;SPEC=%%P&quot;
    call :RESOLVE_SPEC &quot;%SPEC%&quot; RESOLVED_CMD
    if defined RESOLVED_CMD goto :RUN
  )
)

REM 3) .python-version (walk up)
call :FIND_DOTFILE &quot;.python-version&quot; PVFILE
if defined PVFILE (
  for /f &quot;usebackq delims=&quot; %%P in (&quot;%PVFILE%&quot;) do set &quot;SPEC=%%P&quot;
  call :RESOLVE_SPEC &quot;%SPEC%&quot; RESOLVED_CMD
  if defined RESOLVED_CMD goto :RUN
)

REM 4) Global persistence (unless disabled)
if not exist &quot;%GLOBAL_NOPERSIST%&quot; if exist &quot;%GLOBAL_ENV%&quot; (
  for /f &quot;usebackq delims=&quot; %%P in (&quot;%GLOBAL_ENV%&quot;) do set &quot;SPEC=%%P&quot;
  call :RESOLVE_SPEC &quot;%SPEC%&quot; RESOLVED_CMD
  if defined RESOLVED_CMD goto :RUN
)

REM 5) Fallback chain (recursion guards):
REM    - Prefer real py.exe if present and NOT coming from a py.bat shim
where py &gt;NUL 2&gt;&amp;1
if %ERRORLEVEL%==0 if not defined PYSHIM_FROM_PY (
  set &quot;RESOLVED_CMD=py -3.12&quot;
  goto :RUN
)

where py &gt;NUL 2&gt;&amp;1
if %ERRORLEVEL%==0 if not defined PYSHIM_FROM_PY (
  set &quot;RESOLVED_CMD=py -3&quot;
  goto :RUN
)

REM    - Try conda base if available
where conda &gt;NUL 2&gt;&amp;1 &amp;&amp; (set &quot;RESOLVED_CMD=conda run -n base python&quot; &amp; goto :RUN)

REM    - Locate a real python.exe that is NOT this shim directory
for /f &quot;usebackq delims=&quot; %%P in (`where python.exe 2^&gt;NUL`) do (
  REM skip any hit inside the shim folder
  echo &quot;%%~dpP&quot; | find /I &quot;%SHIMDIR%&quot; &gt;NUL
  if errorlevel 1 (
    set &quot;RESOLVED_CMD=%%P&quot;
    goto :RUN
  )
)

REM    - Last resort: error out clearly
echo [pyshim] No real python.exe found on PATH and no usable launcher/conda. 1&gt;&amp;2
exit /b 9009

:RUN
%RESOLVED_CMD% %*
exit /b %ERRORLEVEL%

:RESOLVE_SPEC
REM %1 = SPEC (maybe empty), %2 = outvar
set &quot;_spec=%~1&quot;
if not defined _spec goto :eof

REM absolute path?
if exist &quot;%_spec%&quot; (
  set &quot;%~2=%_spec%&quot;
  goto :eof
)

REM conda:ENV
echo.%_spec%| findstr /b /c:&quot;conda:&quot; &gt;NUL
if not errorlevel 1 (
  set &quot;_env=%_spec:conda:=%&quot;
  set &quot;%~2=conda run -n %_env% python&quot;
  goto :eof
)

REM py:VERSION
echo.%_spec%| findstr /b /c:&quot;py:&quot; &gt;NUL
if not errorlevel 1 (
  set &quot;_ver=%_spec:py:=%&quot;
  set &quot;%~2=py -%_ver%&quot;
  goto :eof
)

REM plain token (treat as exe name): force .exe to avoid re-entering this .bat
if /I &quot;%_spec%&quot;==&quot;python&quot; set &quot;_spec=python.exe&quot;
set &quot;%~2=%_spec%&quot;
goto :eof

:FIND_DOTFILE
REM %1 = filename, %2 = outvar
set &quot;_fn=%~1&quot;
set &quot;_here=%cd%&quot;
set &quot;_visited_dirs=&quot;
:WALKUP
if exist &quot;%_here%\%_fn%&quot; (
  set &quot;%~2=%_here%\%_fn%&quot;
  goto :eof
)
REM Guard against junction/symlink cycles
if defined _visited_dirs (
  echo.|set /p=&quot;|%_here%|&quot; | findstr /I /C:&quot;%_visited_dirs%&quot; &gt;nul &amp;&amp; goto :eof
  set &quot;_visited_dirs=%_visited_dirs%|%_here%&quot;
) else (
  set &quot;_visited_dirs=|%_here%&quot;
)
REM Compute canonical parent using %%~f normalization
for %%P in (&quot;%_here%\..&quot;) do set &quot;_parent=%%~fP&quot;
REM If parent equals current dir, we're at a root (drive or UNC); stop
if /i &quot;%_parent%&quot;==&quot;%_here%&quot; goto :eof
set &quot;_here=%_parent%&quot;
goto :WALKUP
</div></code></pre>
<h2 id="binshimspythonenv"><code>.\bin\shims\python.env</code></h2>
<pre class="hljs"><code><div>C:\Users\h8rt3rmin8r\miniconda3\envs\py312\python.exe
</div></code></pre>
<h2 id="examplespythonenv"><code>.\examples\python.env</code></h2>
<pre class="hljs"><code><div>py:3.12
</div></code></pre>
<h2 id="examplespythonmyserviceenv"><code>.\examples\python@MyService.env</code></h2>
<pre class="hljs"><code><div>conda:myservice
</div></code></pre>
<h2 id="binshimspythonwbat"><code>.\bin\shims\pythonw.bat</code></h2>
<pre class="hljs"><code><div>@echo off
setlocal
REM headless interpreter (best-effort)
&quot;%~dp0python.bat&quot; %*
</div></code></pre>
<h2 id="testssmokeps1"><code>.\tests\smoke.ps1</code></h2>
<pre class="hljs"><code><div><span class="hljs-variable">$ErrorActionPreference</span> = <span class="hljs-string">'Stop'</span>
<span class="hljs-variable">$SepLine</span> = <span class="hljs-string">"`n"</span> + (<span class="hljs-string">"-"</span> * <span class="hljs-number">60</span>) + <span class="hljs-string">"`n"</span>
<span class="hljs-variable">$TotalDurationMax</span> = <span class="hljs-number">12</span>    <span class="hljs-comment"># seconds</span>
<span class="hljs-variable">$SingleDurationMax</span> = <span class="hljs-number">3</span>    <span class="hljs-comment"># seconds</span>
<span class="hljs-variable">$StartTime</span> = <span class="hljs-built_in">Get-Date</span>
<span class="hljs-variable">$TestsFailed</span> = <span class="hljs-variable">$false</span>

<span class="hljs-comment">#-------------------------------------------------------------------------------</span>
<span class="hljs-comment"># Helper function to run a command with timeout and exit code monitoring</span>
<span class="hljs-comment">#-------------------------------------------------------------------------------</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Invoke-TimedCommand</span></span> {
    <span class="hljs-function">[<span class="hljs-type">CmdletBinding</span>()]</span>
    <span class="hljs-keyword">Param</span>(
        [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$true</span>)]
        [<span class="hljs-type">System.String</span>]<span class="hljs-variable">$Description</span>,

        [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$true</span>)]
        [<span class="hljs-type">ScriptBlock</span>]<span class="hljs-variable">$Command</span>,

        [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$false</span>)]
        [<span class="hljs-type">System.Int32</span>]<span class="hljs-variable">$TimeoutSeconds</span> = <span class="hljs-variable">$script:SingleDurationMax</span>,

        [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$false</span>)]
        [<span class="hljs-type">Switch</span>]<span class="hljs-variable">$IsGetCommand</span>
    )

    <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"  Running: <span class="hljs-variable">$Description</span>"</span> <span class="hljs-literal">-ForegroundColor</span> Cyan
    <span class="hljs-variable">$CommandStart</span> = <span class="hljs-built_in">Get-Date</span>
    <span class="hljs-variable">$Job</span> = <span class="hljs-built_in">Start-Job</span> <span class="hljs-literal">-ScriptBlock</span> <span class="hljs-variable">$Command</span>

    <span class="hljs-variable">$Completed</span> = <span class="hljs-built_in">Wait-Job</span> <span class="hljs-literal">-Job</span> <span class="hljs-variable">$Job</span> <span class="hljs-literal">-Timeout</span> <span class="hljs-variable">$TimeoutSeconds</span>
    <span class="hljs-variable">$CommandEnd</span> = <span class="hljs-built_in">Get-Date</span>
    <span class="hljs-variable">$Duration</span> = (<span class="hljs-variable">$CommandEnd</span> - <span class="hljs-variable">$CommandStart</span>).TotalSeconds

    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$null</span> <span class="hljs-operator">-eq</span> <span class="hljs-variable">$Completed</span>) {
        <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"    TIMEOUT after <span class="hljs-variable">$Duration</span> seconds (max: <span class="hljs-variable">$TimeoutSeconds</span>)"</span> <span class="hljs-literal">-ForegroundColor</span> Red
        <span class="hljs-built_in">Stop-Job</span> <span class="hljs-literal">-Job</span> <span class="hljs-variable">$Job</span> <span class="hljs-literal">-ErrorAction</span> SilentlyContinue
        <span class="hljs-built_in">Remove-Job</span> <span class="hljs-literal">-Job</span> <span class="hljs-variable">$Job</span> <span class="hljs-literal">-Force</span> <span class="hljs-literal">-ErrorAction</span> SilentlyContinue
        <span class="hljs-variable">$script:TestsFailed</span> = <span class="hljs-variable">$true</span>
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$false</span>
    }

    <span class="hljs-variable">$JobOutput</span> = <span class="hljs-built_in">Receive-Job</span> <span class="hljs-literal">-Job</span> <span class="hljs-variable">$Job</span> <span class="hljs-literal">-ErrorAction</span> SilentlyContinue
    <span class="hljs-variable">$JobState</span> = <span class="hljs-variable">$Job</span>.State
    <span class="hljs-variable">$JobError</span> = <span class="hljs-variable">$Job</span>.ChildJobs[<span class="hljs-number">0</span>].Error

    <span class="hljs-built_in">Remove-Job</span> <span class="hljs-literal">-Job</span> <span class="hljs-variable">$Job</span> <span class="hljs-literal">-Force</span> <span class="hljs-literal">-ErrorAction</span> SilentlyContinue

    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$JobState</span> <span class="hljs-operator">-eq</span> <span class="hljs-string">'Failed'</span> <span class="hljs-operator">-or</span> (<span class="hljs-variable">$JobError</span> <span class="hljs-operator">-and</span> <span class="hljs-variable">$JobError</span>.Count <span class="hljs-operator">-gt</span> <span class="hljs-number">0</span>)) {
        <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"    FAILED (duration: <span class="hljs-variable">$Duration</span> seconds)"</span> <span class="hljs-literal">-ForegroundColor</span> Red
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$JobError</span>) {
            <span class="hljs-variable">$JobError</span> | <span class="hljs-built_in">ForEach-Object</span> { <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"      ERROR: <span class="hljs-variable">$_</span>"</span> <span class="hljs-literal">-ForegroundColor</span> Red }
        }
        <span class="hljs-variable">$script:TestsFailed</span> = <span class="hljs-variable">$true</span>
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$false</span>
    }

    <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"    OK (duration: <span class="hljs-variable">$Duration</span> seconds)"</span> <span class="hljs-literal">-ForegroundColor</span> Green
    
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$JobOutput</span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$IsGetCommand</span>) {
            <span class="hljs-variable">$JsonOutput</span> = <span class="hljs-variable">$JobOutput</span> | <span class="hljs-built_in">Select-Object</span> CommandType, Name, Version, Source | <span class="hljs-built_in">ConvertTo-Json</span> <span class="hljs-literal">-Compress</span>
            <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"      <span class="hljs-variable">$JsonOutput</span>"</span> <span class="hljs-literal">-ForegroundColor</span> Gray
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-variable">$FlatOutput</span> = (<span class="hljs-variable">$JobOutput</span> | <span class="hljs-built_in">Out-String</span>).Trim() <span class="hljs-operator">-replace</span> <span class="hljs-string">"`r`n"</span>, <span class="hljs-string">", "</span> <span class="hljs-operator">-replace</span> <span class="hljs-string">"`n"</span>, <span class="hljs-string">", "</span>
            <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"      <span class="hljs-variable">$FlatOutput</span>"</span> <span class="hljs-literal">-ForegroundColor</span> Gray
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$true</span>
}

<span class="hljs-comment">#-------------------------------------------------------------------------------</span>
<span class="hljs-built_in">Write-Host</span> <span class="hljs-string">''</span>
<span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"Beginning smoke tests for pyshim."</span> <span class="hljs-literal">-ForegroundColor</span> Green
<span class="hljs-comment">#-------------------------------------------------------------------------------</span>

<span class="hljs-variable">$SepLine</span> | <span class="hljs-built_in">Write-Host</span>
<span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"Checking for py, python, and pip commands in PATH:"</span> <span class="hljs-literal">-ForegroundColor</span> Yellow

<span class="hljs-built_in">Invoke-TimedCommand</span> <span class="hljs-literal">-Description</span> <span class="hljs-string">"where.exe py"</span> <span class="hljs-literal">-Command</span> {
    where.exe py
    <span class="hljs-variable">$LASTEXITCODE</span>
} | <span class="hljs-built_in">Out-Null</span>

<span class="hljs-built_in">Invoke-TimedCommand</span> <span class="hljs-literal">-Description</span> <span class="hljs-string">"where.exe python"</span> <span class="hljs-literal">-Command</span> {
    where.exe python
    <span class="hljs-variable">$LASTEXITCODE</span>
} | <span class="hljs-built_in">Out-Null</span>

<span class="hljs-built_in">Invoke-TimedCommand</span> <span class="hljs-literal">-Description</span> <span class="hljs-string">"where.exe pip"</span> <span class="hljs-literal">-Command</span> {
    where.exe pip
    <span class="hljs-variable">$LASTEXITCODE</span>
} | <span class="hljs-built_in">Out-Null</span>

<span class="hljs-comment">#-------------------------------------------------------------------------------</span>
<span class="hljs-variable">$SepLine</span> | <span class="hljs-built_in">Write-Host</span>
<span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"Verifying that py, python, and pip commands are functional:"</span> <span class="hljs-literal">-ForegroundColor</span> Yellow

<span class="hljs-built_in">Invoke-TimedCommand</span> <span class="hljs-literal">-Description</span> <span class="hljs-string">"Get-Command py"</span> <span class="hljs-literal">-IsGetCommand</span> <span class="hljs-literal">-Command</span> {
    <span class="hljs-built_in">Get-Command</span> py <span class="hljs-literal">-ErrorAction</span> Stop
} | <span class="hljs-built_in">Out-Null</span>

<span class="hljs-built_in">Invoke-TimedCommand</span> <span class="hljs-literal">-Description</span> <span class="hljs-string">"Get-Command python"</span> <span class="hljs-literal">-IsGetCommand</span> <span class="hljs-literal">-Command</span> {
    <span class="hljs-built_in">Get-Command</span> python <span class="hljs-literal">-ErrorAction</span> Stop
} | <span class="hljs-built_in">Out-Null</span>

<span class="hljs-built_in">Invoke-TimedCommand</span> <span class="hljs-literal">-Description</span> <span class="hljs-string">"Get-Command pip"</span> <span class="hljs-literal">-IsGetCommand</span> <span class="hljs-literal">-Command</span> {
    <span class="hljs-built_in">Get-Command</span> pip <span class="hljs-literal">-ErrorAction</span> Stop
} | <span class="hljs-built_in">Out-Null</span>

<span class="hljs-comment">#-------------------------------------------------------------------------------</span>
<span class="hljs-variable">$SepLine</span> | <span class="hljs-built_in">Write-Host</span>
<span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"Checking versions of py, python, and pip:"</span> <span class="hljs-literal">-ForegroundColor</span> Yellow

<span class="hljs-built_in">Invoke-TimedCommand</span> <span class="hljs-literal">-Description</span> <span class="hljs-string">"py -V"</span> <span class="hljs-literal">-Command</span> {
    py <span class="hljs-literal">-V</span>
    <span class="hljs-variable">$LASTEXITCODE</span>
} | <span class="hljs-built_in">Out-Null</span>

<span class="hljs-built_in">Invoke-TimedCommand</span> <span class="hljs-literal">-Description</span> <span class="hljs-string">"python -V"</span> <span class="hljs-literal">-Command</span> {
    python <span class="hljs-literal">-V</span>
    <span class="hljs-variable">$LASTEXITCODE</span>
} | <span class="hljs-built_in">Out-Null</span>

<span class="hljs-built_in">Invoke-TimedCommand</span> <span class="hljs-literal">-Description</span> <span class="hljs-string">"pip --version"</span> <span class="hljs-literal">-Command</span> {
    pip -<span class="hljs-literal">-version</span>
    <span class="hljs-variable">$LASTEXITCODE</span>
} | <span class="hljs-built_in">Out-Null</span>

<span class="hljs-comment">#-------------------------------------------------------------------------------</span>
<span class="hljs-variable">$SepLine</span> | <span class="hljs-built_in">Write-Host</span>
<span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"Running a simple Python command using the pyshim function Run-WithPython:"</span> <span class="hljs-literal">-ForegroundColor</span> Yellow

<span class="hljs-built_in">Invoke-TimedCommand</span> <span class="hljs-literal">-Description</span> <span class="hljs-string">"Run-WithPython -Spec 'py:3' -- -c `"print('ok')`""</span> <span class="hljs-literal">-Command</span> {
    <span class="hljs-built_in">Import-Module</span> <span class="hljs-string">'C:\bin\shims\pyshim.psm1'</span> <span class="hljs-literal">-Force</span>
    Run<span class="hljs-literal">-WithPython</span> <span class="hljs-literal">-Spec</span> <span class="hljs-string">'py:3'</span> -- <span class="hljs-literal">-c</span> <span class="hljs-string">"print('ok')"</span>
    <span class="hljs-variable">$LASTEXITCODE</span>
} | <span class="hljs-built_in">Out-Null</span>

<span class="hljs-comment">#-------------------------------------------------------------------------------</span>
<span class="hljs-variable">$SepLine</span> | <span class="hljs-built_in">Write-Host</span>
<span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"Testing dotfile search from drive root (regression check for infinite loop):"</span> <span class="hljs-literal">-ForegroundColor</span> Yellow

<span class="hljs-built_in">Invoke-TimedCommand</span> <span class="hljs-literal">-Description</span> <span class="hljs-string">"python -c `"print('ok from root')`" (from C:\)"</span> <span class="hljs-literal">-Command</span> {
    <span class="hljs-built_in">Push-Location</span> C:\
    <span class="hljs-keyword">try</span> {
        <span class="hljs-variable">$output</span> = &amp; python <span class="hljs-literal">-c</span> <span class="hljs-string">"print('ok from root')"</span> <span class="hljs-number">2</span>&gt;&amp;<span class="hljs-number">1</span>
        <span class="hljs-variable">$exitCode</span> = <span class="hljs-variable">$LASTEXITCODE</span>
        <span class="hljs-built_in">Pop-Location</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$exitCode</span> <span class="hljs-operator">-ne</span> <span class="hljs-number">0</span>) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"Exit code: <span class="hljs-variable">$exitCode</span>"</span> }
        <span class="hljs-variable">$exitCode</span>
    } <span class="hljs-keyword">catch</span> {
        <span class="hljs-built_in">Pop-Location</span>
        <span class="hljs-keyword">throw</span>
    }
} | <span class="hljs-built_in">Out-Null</span>

<span class="hljs-comment">#-------------------------------------------------------------------------------</span>
<span class="hljs-variable">$SepLine</span> | <span class="hljs-built_in">Write-Host</span>
<span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"Testing dotfile search from UNC path (if available):"</span> <span class="hljs-literal">-ForegroundColor</span> Yellow

<span class="hljs-variable">$UncPath</span> = <span class="hljs-string">"\\localhost\c<span class="hljs-variable">$</span>"</span>
<span class="hljs-keyword">if</span> (<span class="hljs-built_in">Test-Path</span> <span class="hljs-literal">-LiteralPath</span> <span class="hljs-variable">$UncPath</span> <span class="hljs-literal">-ErrorAction</span> SilentlyContinue) {
    <span class="hljs-built_in">Invoke-TimedCommand</span> <span class="hljs-literal">-Description</span> <span class="hljs-string">"python -c `"print('ok from UNC')`" (from <span class="hljs-variable">$UncPath</span>)"</span> <span class="hljs-literal">-Command</span> {
        <span class="hljs-built_in">Push-Location</span> <span class="hljs-variable">$UncPath</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-variable">$output</span> = &amp; python <span class="hljs-literal">-c</span> <span class="hljs-string">"print('ok from UNC')"</span> <span class="hljs-number">2</span>&gt;&amp;<span class="hljs-number">1</span>
            <span class="hljs-variable">$exitCode</span> = <span class="hljs-variable">$LASTEXITCODE</span>
            <span class="hljs-built_in">Pop-Location</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$exitCode</span> <span class="hljs-operator">-ne</span> <span class="hljs-number">0</span>) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"Exit code: <span class="hljs-variable">$exitCode</span>"</span> }
            <span class="hljs-variable">$exitCode</span>
        } <span class="hljs-keyword">catch</span> {
            <span class="hljs-built_in">Pop-Location</span>
            <span class="hljs-keyword">throw</span>
        }
    } | <span class="hljs-built_in">Out-Null</span>
} <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"  Skipped (UNC path not accessible)"</span> <span class="hljs-literal">-ForegroundColor</span> Gray
}

<span class="hljs-comment">#-------------------------------------------------------------------------------</span>
<span class="hljs-variable">$SepLine</span> | <span class="hljs-built_in">Write-Host</span>
<span class="hljs-variable">$EndTime</span> = <span class="hljs-built_in">Get-Date</span>
<span class="hljs-variable">$TotalDuration</span> = (<span class="hljs-variable">$EndTime</span> - <span class="hljs-variable">$StartTime</span>).TotalSeconds

<span class="hljs-keyword">if</span> (<span class="hljs-variable">$TestsFailed</span>) {
    <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"Total duration: <span class="hljs-variable">$TotalDuration</span> seconds."</span> <span class="hljs-literal">-ForegroundColor</span> Red
    <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"Smoke FAILED: One or more tests failed."</span> <span class="hljs-literal">-ForegroundColor</span> Red
    <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"Exiting script."</span> <span class="hljs-literal">-ForegroundColor</span> Red
    <span class="hljs-keyword">exit</span> <span class="hljs-number">1</span>
} <span class="hljs-keyword">elseif</span> (<span class="hljs-variable">$TotalDuration</span> <span class="hljs-operator">-gt</span> <span class="hljs-variable">$TotalDurationMax</span>) {
    <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"Total duration: <span class="hljs-variable">$TotalDuration</span> seconds."</span> <span class="hljs-literal">-ForegroundColor</span> Red
    <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"Smoke FAILED: Total duration exceeds maximum of <span class="hljs-variable">$TotalDurationMax</span> seconds."</span> <span class="hljs-literal">-ForegroundColor</span> Red
    <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"Exiting script."</span> <span class="hljs-literal">-ForegroundColor</span> Red
    <span class="hljs-keyword">exit</span> <span class="hljs-number">1</span>
} <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"Total duration: <span class="hljs-variable">$TotalDuration</span> seconds."</span> <span class="hljs-literal">-ForegroundColor</span> Green
    <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"Smoke OK (Tests passed successfully)."</span> <span class="hljs-literal">-ForegroundColor</span> Green
    <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"Exiting script."</span> <span class="hljs-literal">-ForegroundColor</span> Green
    <span class="hljs-keyword">exit</span> <span class="hljs-number">0</span>
}
</div></code></pre>

</body>
</html>
